<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resto Ops Hub - Dashboard Operasional Restoran</title>
  <script>
    window.tailwind = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
          },
        },
      },
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    /* Simple scrollbar styling for better UX */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.6);
      border-radius: 9999px;
    }
    ::-webkit-scrollbar-track {
      background-color: rgba(15, 23, 42, 0.05);
    }

    /* Global text & field styling as requested */
    body {
      color: #000;
    }
    .text-slate-50, .text-slate-100, .text-slate-200,
    .text-slate-300, .text-slate-400, .text-slate-500,
    .text-slate-600, .text-slate-700, .text-slate-800,
    .text-slate-900 {
      color: #000 !important;
    }
    input, textarea, select {
      background-color: #ffffff !important;
      color: #000000 !important;
    }

    /* Border khusus untuk tabel kalender jadwal, daftar tugas, riwayat preparation, checklist harian, dan daftar feedback */
    #scheduleCalendar table,
    #section-tasks table,
    #section-preparation table,
    #section-cleaning table,
    #section-feedback table,
    #section-inventory table,
    #section-logbook table,
    #section-rejects table {
      border-collapse: collapse;
      width: 100%;
    }
    #scheduleCalendar th,
    #scheduleCalendar td,
    #section-tasks th,
    #section-tasks td,
    #section-preparation th,
    #section-preparation td,
    #section-cleaning th,
    #section-cleaning td,
    #section-feedback th,
    #section-feedback td,
    #section-inventory th,
    #section-inventory td,
    #section-logbook th,
    #section-logbook td,
    #section-rejects th,
    #section-rejects td {
      border: 1px solid #cbd5e1; /* slate-300 */
    }

    /* Sidebar mobile (burger) */
    @media (max-width: 767px) {
      #sidebar.sidebar-mobile-open {
        position: fixed;
        top: 3.25rem; /* kira-kira tinggi header */
        left: 0;
        bottom: 0;
        width: 16rem;
        max-width: 80vw;
        background-color: #ffffff;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
        z-index: 50;
        padding: 0.5rem;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body class="bg-white text-slate-900 font-sans">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-emerald-100/90 border-b border-emerald-200 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-emerald-500/10 border border-emerald-500/40 flex items-center justify-center text-emerald-600 font-semibold text-lg">
            R
          </div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold tracking-tight">Resto Ops Hub</h1>

          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 sm:gap-4">
          <button id="sidebarToggleBtn" class="md:hidden inline-flex items-center justify-center px-3 py-1.5 rounded-lg border border-slate-300 bg-white text-[11px] font-medium text-slate-700 focus:outline-none" aria-label="Buka menu navigasi">
            <span>Menu</span>
          </button>

          <div class="flex flex-col text-xs">
            <label for="outletSelect" class="text-slate-500 mb-0.5">Pilih Outlet</label>
            <select id="outletSelect" class="bg-white border border-slate-300 text-xs sm:text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-500/70 min-w-[10rem]">
            </select>
          </div>

          <div class="flex items-center gap-2 text-xs">
            <span id="adminStatus" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-slate-100 border border-slate-300 text-slate-700">
              <span id="adminDot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
              <span id="adminStatusText">Peran: Karyawan</span>
            </span>
            <button id="headLoginBtn" class="px-3 py-1 rounded-lg border border-amber-500/60 text-amber-700 text-[11px] sm:text-xs font-medium hover:bg-amber-50 transition">
              Masuk Kepala Cabang
            </button>
            <button id="areaLoginBtn" class="px-3 py-1 rounded-lg border border-sky-500/60 text-sky-700 text-[11px] sm:text-xs font-medium hover:bg-sky-50 transition">
              Masuk Area Manager
            </button>
            <button id="adminLoginBtn" class="px-3 py-1 rounded-lg border border-emerald-500/60 text-emerald-700 text-[11px] sm:text-xs font-medium hover:bg-emerald-50 transition">
              Masuk Admin
            </button>
            <button id="adminLogoutBtn" class="hidden px-3 py-1 rounded-lg border border-slate-400 text-slate-700 text-[11px] sm:text-xs font-medium hover:bg-slate-100 transition">
              Keluar
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 flex flex-col md:flex-row gap-4 lg:gap-6">
        <!-- Sidebar Nav -->
        <aside id="sidebar" class="md:w-56 lg:w-64 shrink-0 md:sticky md:top-4 hidden md:block">
          <nav class="bg-white rounded-2xl p-2 shadow-lg flex flex-col gap-1 overflow-auto">
            <button data-section="dashboard" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium bg-emerald-50 text-emerald-700">
              Dashboard
            </button>
            <button data-section="schedule" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Jadwal Kerja
            </button>
            <button data-section="tasks" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Tugas Harian
            </button>
            <button data-section="preparation" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Preparation Bahan Baku
            </button>
            <button data-section="cleaning" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Checklist Operasional
            </button>
            <button data-section="rejects" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Barang Reject
            </button>
            <button data-section="inventory" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Inventori (FIFO/FEFO)
            </button>
            <button data-section="logbook" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Log Book
            </button>
            <button data-section="feedback" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium hover:bg-slate-100">
              Customer Feedback
            </button>
            <button id="checklistSettingsNav" data-section="checklists" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium text-slate-700 hover:bg-slate-100 hidden">
              Pengaturan Checklist (Admin)
            </button>
            <button id="outletSettingsNav" data-section="outlets" class="section-tab w-full justify-start inline-flex items-center px-3 py-2 rounded-xl text-xs sm:text-sm font-medium text-slate-700 hover:bg-slate-100 hidden">
              Pengaturan Outlet (Admin)
            </button>
          </nav>
        </aside>

        <!-- Content -->
        <section class="flex-1 space-y-5 lg:space-y-6">
          <!-- Dashboard -->
          <section id="section-dashboard" class="space-y-4 lg:space-y-5">
            <header class="flex flex-wrap items-center justify-between gap-2">
              <div>
                <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Dashboard Outlet</h2>

              </div>
              <div class="text-xs sm:text-sm text-slate-600">
                Outlet aktif: <span id="dashOutletName" class="font-medium">-</span>
              </div>
            </header>

            <!-- Dashboard Admin Global (hanya untuk Admin) -->
            <div id="adminGlobalDashboard" class="hidden space-y-3">
              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Ringkasan Semua Outlet (Admin)</h3>
                  <span id="adminDashDateLabel" class="text-[11px] text-slate-600">-</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-[11px] sm:text-xs">
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Total Outlet</div>
                    <div id="adminDashTotalOutlets" class="text-lg font-semibold">0</div>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Checklist Hari Ini</div>
                    <div id="adminDashChecklist" class="text-lg font-semibold">0 / 0</div>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Preparation Hari Ini</div>
                    <div id="adminDashPrep" class="text-lg font-semibold">0</div>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Tugas Hari Ini</div>
                    <div id="adminDashTasks" class="text-lg font-semibold">0 (0 pending)</div>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Reject Hari Ini</div>
                    <div id="adminDashReject" class="text-lg font-semibold">0</div>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Feedback Negatif Hari Ini</div>
                    <div id="adminDashFbNeg" class="text-lg font-semibold">0</div>
                  </div>
                </div>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Ringkasan Per Outlet - Hari Ini</h3>
                  <span id="adminOutletSummaryLabel" class="text-[11px] text-slate-600">- outlet</span>
                </div>
                <div class="overflow-auto max-h-[260px] text-[11px] sm:text-xs">
                  <table class="min-w-full border-separate border-spacing-y-1">
                    <thead class="text-[11px] uppercase text-slate-600">
                      <tr>
                        <th class="text-left px-2 py-1.5">Outlet</th>
                        <th class="text-left px-2 py-1.5">Checklist (Selesai/Total)</th>
                        <th class="text-left px-2 py-1.5">Prep</th>
                        <th class="text-left px-2 py-1.5">Tugas Pending</th>
                        <th class="text-left px-2 py-1.5">Reject Qty</th>
                        <th class="text-left px-2 py-1.5">Feedback Negatif</th>
                      </tr>
                    </thead>
                    <tbody id="adminOutletSummaryBody"></tbody>
                  </table>
                </div>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Tren 7 Hari (Semua Outlet)</h3>
                  <span id="adminTrendRangeLabel" class="text-[11px] text-slate-600">-</span>
                </div>
                <div class="overflow-auto max-h-[260px] text-[11px] sm:text-xs">
                  <table class="min-w-full border-separate border-spacing-y-1">
                    <thead class="text-[11px] uppercase text-slate-600">
                      <tr>
                        <th class="text-left px-2 py-1.5">Tanggal</th>
                        <th class="text-left px-2 py-1.5">Checklist (Selesai/Total)</th>
                        <th class="text-left px-2 py-1.5">Reject Qty</th>
                        <th class="text-left px-2 py-1.5">Feedback Negatif/Total</th>
                      </tr>
                    </thead>
                    <tbody id="adminTrendBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 shadow-sm flex flex-col gap-1.5">
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">Item mendekati habis</span>
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">Inventori</span>
                </div>
                <div class="text-2xl font-semibold text-amber-700" id="dashLowStock">0</div>
                <p class="text-[11px] text-slate-600">Berdasarkan batas minimum stok.</p>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 shadow-sm flex flex-col gap-1.5">
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">Expired â‰¤ 7 hari</span>
                  <span classtext-[10px] px-1.5 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200">FIFO/FEFO</span>
                </div>
                <div class="text-2xl font-semibold text-red-700" id="dashUpcomingExpiry">0</div>
                <p class="text-[11px] text-slate-600">Prioritaskan pemakaian FEFO.</p>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 shadow-sm flex flex-col gap-1.5">
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">Tugas hari ini</span>
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-200">Operasional</span>
                </div>
                <div class="text-2xl font-semibold text-sky-700" id="dashPendingTasks">0</div>
                <p class="text-[11px] text-slate-600">Tugas harian yang belum selesai.</p>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 shadow-sm flex flex-col gap-1.5">
                <div class="flex items-center justify-between">
                  <span class="text-xs text-slate-600">Rata-rata rating</span>
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Feedback</span>
                </div>
                <div class="text-2xl font-semibold text-emerald-700" id="dashAvgRating">-</div>
                <p class="text-[11px] text-slate-600">Dari Google Review, WA, Instagram, dll.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-5">
              <div class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Ringkasan Hari Ini</h3>
                  <span class="text-[11px] text-slate-600" id="dashTodayLabel"></span>
                </div>
                <div class="grid sm:grid-cols-3 gap-3 text-[11px] sm:text-xs">
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Preparation</div>
                    <div id="dashPrepCount" class="text-lg font-semibold">0</div>
                    <p class="mt-0.5">Batch prep yang tercatat hari ini.</p>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Checklist Operasional</div>
                    <div id="dashCleaningDone" class="text-lg font-semibold">0 / 0</div>
                    <p class="mt-0.5">Checklist selesai / total hari ini.</p>
                  </div>
                  <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
                    <div class="mb-1">Feedback Masuk</div>
                    <div id="dashFeedbackToday" class="text-lg font-semibold">0</div>
                    <p class="mt-0.5">Semua channel yang tercatat hari ini.</p>
                  </div>
                </div>
              </div>

            </div>
          </section>

          <!-- Inventory -->
          <section id="section-inventory" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Inventori & Kontrol Stok</h2>
              <p class="text-xs sm:text-sm text-slate-600">Catat stok masuk/keluar, pantau stok minimum, dan pantau urutan pemakaian menurut FIFO/FEFO.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between gap-2 mb-1">
                <h3 class="text-sm font-semibold">Tambah / Update Item Inventori</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="invOutletName" class="font-medium">-</span></span>
              </div>
              <form id="inventoryForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div class="md:col-span-2">
                  <label class="block mb-1">Nama Item</label>
                  <input id="invName" list="invNameList" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Contoh: Daging ayam fillet" />
                  <datalist id="invNameList"></datalist>
                </div>
                <div>
                  <label class="block mb-1">Jenis</label>
                  <select id="invCategory" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih jenis...</option>
                    <option value="P00">P00</option>
                    <option value="BBJ">BBJ</option>
                    <option value="BBF">BBF</option>
                    <option value="RSI">RSI</option>
                    <option value="RSB">RSB</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">In</label>
                  <input id="invStock" type="number" step="0.01" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Satuan</label>
                  <select id="invUnit" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih satuan...</option>
                    <option value="Kg">Kg</option>
                    <option value="Grm">Grm</option>
                    <option value="Ltr">Ltr</option>
                    <option value="Ml">Ml</option>
                    <option value="Pcs">Pcs</option>
                    <option value="Prs">Prs</option>
                    <option value="Pack">Pack</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1">Jumlah Stok Saat Ini</label>
                  <input id="invCurrentStock" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-slate-50 focus:outline-none" placeholder="-" readonly />
                </div>
                <div>
                  <label class="block mb-1">Tanggal Expired</label>
                  <input id="invExpiry" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Tanggal Produksi</label>
                  <input id="invProduction" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Minimum Stok</label>
                  <input id="invMinStock" type="number" step="0.01" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Contoh: 5" />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Item</button>
                </div>
              </form>
            </div>

            <!-- Stok Keluar / Pemakaian -->
            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between gap-2 mb-1">
                <h3 class="text-sm font-semibold">Catat Stok Keluar / Pemakaian</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="stockOutOutletName" class="font-medium">-</span></span>
              </div>
              <form id="stockOutForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div class="md:col-span-2">
                  <label class="block mb-1">Pilih Item</label>
                  <select id="stockOutItem" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih item...</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="stockOutDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Out</label>
                  <input id="stockOutQty" type="number" step="0.01" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">PIC</label>
                  <input id="stockOutPic" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Nama" />
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1">Tanggal Produksi</label>
                  <input id="stockOutProduction" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Otomatis dari item" readonly />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Stok Keluar</button>
                </div>
              </form>

              <div class="border-t border-slate-200 pt-3">
                <div class="flex items-center justify-between mb-1">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                    <h4 class="text-xs font-semibold">Riwayat Stok Keluar</h4>
                    <div class="flex items-center gap-1 text-[11px] text-slate-600">
                      <span>Tanggal:</span>
                      <input id="stockOutFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                    </div>
                  </div>
                  <span class="text-[11px] text-slate-600" id="stockOutCountLabel">0 transaksi</span>
                </div>
                <div class="overflow-auto max-h-[220px] text-[11px] sm:text-xs">
                  <table class="min-w-full border-separate border-spacing-y-1">
                    <thead class="text-[11px] uppercase text-slate-600">
                      <tr>
                        <th class="text-left px-2 py-1.5">Tanggal</th>
                        <th class="text-left px-2 py-1.5">Item</th>
                        <th class="text-left px-2 py-1.5">Qty</th>
                        <th class="text-left px-2 py-1.5">PIC</th>
                        <th class="text-left px-2 py-1.5">Tgl Produksi</th>
                        <th class="text-right px-2 py-1.5">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="stockOutTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Reset / Bersihkan Data Inventori -->
            <div class="bg-white border border-rose-200 rounded-2xl p-3.5 sm:p-4 shadow-sm space-y-2 text-[11px] sm:text-xs">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">Reset / Bersihkan Data Inventori</h3>
                <span class="text-[11px] text-slate-600">Hanya outlet aktif</span>
              </div>
              <p class="text-slate-600">Hapus riwayat stok keluar yang lebih lama dari tanggal tertentu untuk outlet yang sedang dipilih. Stok saat ini tidak berubah.</p>
              <form id="invCleanupForm" class="flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-[11px]">Hapus data lebih lama dari:</span>
                  <select id="invCleanupRange" class="border border-slate-300 rounded-lg px-2.5 py-1.5 text-[11px] bg-white focus:outline-none focus:ring-2 focus:ring-rose-500/60 focus:border-rose-500/60">
                    <option value="">Pilih rentang...</option>
                    <option value="7">7 hari yang lalu</option>
                    <option value="14">14 hari yang lalu</option>
                    <option value="30">30 hari yang lalu</option>
                  </select>
                </div>
                <button type="submit" class="px-3 py-2 rounded-lg bg-rose-500 hover:bg-rose-600 text-white text-[11px] font-medium transition">Bersihkan Data</button>
              </form>
              <p class="text-[11px] text-slate-500">Yang dihapus: riwayat "Stok Keluar" sebelum tanggal batas. Data inventori dan stok saat ini tetap aman.</p>
            </div>

            <div class="space-y-4 lg:space-y-5">
              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
                  <div class="flex items-center justify-between sm:justify-start gap-2">
                    <h3 class="text-sm font-semibold">Daftar Inventori Outlet</h3>
                    <span class="text-[11px] text-slate-600" id="invCountLabel">0 item</span>
                  </div>
                  <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2 sm:items-center">
                    <div class="w-full sm:w-40">
                      <select id="invTypeFilter" class="w-full border border-slate-300 rounded-lg px-2.5 py-1.5 text-[11px] bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                        <option value="">Semua jenis</option>
                        <option value="P00">P00</option>
                        <option value="BBJ">BBJ</option>
                        <option value="BBF">BBF</option>
                        <option value="RSI">RSI</option>
                        <option value="RSB">RSB</option>
                      </select>
                    </div>
                    <div class="w-full sm:w-48">
                      <input id="invSearch" type="text" class="w-full border border-slate-300 rounded-lg px-2.5 py-1.5 text-[11px] focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Cari nama item..." />
                    </div>
                  </div>
                </div>
                <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                  <table class="min-w-full border-separate border-spacing-y-1">
                    <thead class="text-[11px] uppercase text-slate-600">
                      <tr>
                        <th class="text-left px-2 py-1.5">Item</th>
                        <th class="text-left px-2 py-1.5">Jenis</th>
                        <th class="text-right px-2 py-1.5">Stok</th>
                        <th class="text-left px-2 py-1.5">Expired</th>
                        <th class="text-left px-2 py-1.5">Tgl Produksi</th>
                        <th class="text-left px-2 py-1.5">Status</th>
                        <th class="text-right px-2 py-1.5">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                  </table>
                </div>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Rekomendasi Urutan Pakai (FEFO)</h3>
                  <span class="text-[11px] text-slate-600">Berdasarkan tanggal expired</span>
                </div>
                <ol id="inventoryFefoList" class="space-y-1.5 text-[11px] sm:text-xs max-h-60 overflow-auto">
                  <!-- Filled by JS -->
                </ol>
                <p class="text-[11px] text-slate-600 border-t border-slate-200 pt-2 mt-1">Gunakan daftar ini untuk menentukan bahan mana yang harus dipakai lebih dulu agar mengurangi waste.</p>
              </div>
            </div>
          </section>

          <!-- Preparation -->
          <section id="section-preparation" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Preparation Bahan Baku</h2>
              <p class="text-xs sm:text-sm text-slate-600">Catat batch preparation (prep harian), siapa yang mengerjakan, dan peruntukannya.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Tambah Batch Preparation</h3>
                <span class="text-[11px] text-slate-600">Terkait outlet: <span id="prepOutletName" class="font-medium">-</span></span>
              </div>
              <form id="prepForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="prepDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1">PIC / Koki</label>
                  <select id="prepPic" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih karyawan (otomatis dari jadwal)</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Shift</label>
                  <select id="prepShift" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">(otomatis dari jadwal atau pilih manual)</option>
                    <option value="P">P</option>
                    <option value="M">M</option>
                    <option value="S">S</option>
                    <option value="FT">FT</option>
                    <option value="FT1">FT1</option>
                    <option value="FT2">FT2</option>
                    <option value="Off">Off</option>
                    <option value="Cuti">Cuti</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1">Nama Item / Menu</label>
                  <select id="prepItem" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih item/menu...</option>
                    <option value="Masak nasi putih">Masak nasi putih</option>
                    <option value="Masak nasi pera">Masak nasi pera</option>
                    <option value="Buat sambal terasi">Buat sambal terasi</option>
                    <option value="Buat sambal mercon">Buat sambal mercon</option>
                    <option value="Buat sambal matah">Buat sambal matah</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Qty Prep</label>
                  <input id="prepQty" type="number" step="0.01" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Satuan</label>
                  <select id="prepUnit" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih satuan...</option>
                    <option value="Kg">Kg</option>
                    <option value="Grm">Grm</option>
                    <option value="Pcs">Pcs</option>
                    <option value="Prs">Prs</option>
                    <option value="Ml">Ml</option>
                    <option value="Ltr">Ltr</option>
                    <option value="Pack">Pack</option>
                  </select>
                </div>
                <div class="md:col-span-4">
                  <label class="block mb-1">Keterangan</label>
                  <input id="prepNote" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Contoh: untuk service lunch, untuk stok chiller 2 hari" />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Preparation</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                  <h3 class="text-sm font-semibold">Riwayat Preparation</h3>
                  <div class="flex items-center gap-1 text-[11px] text-slate-600">
                    <span>Tanggal:</span>
                    <input id="prepFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                  </div>
                </div>
                <span class="text-[11px] text-slate-600" id="prepCountLabel">0 batch</span>
              </div>
              <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Tanggal</th>
                      <th class="text-left px-2 py-1.5">Item</th>
                      <th class="text-left px-2 py-1.5">Qty</th>
                      <th class="text-left px-2 py-1.5">Shift</th>
                      <th class="text-left px-2 py-1.5">PIC</th>
                      <th class="text-left px-2 py-1.5">Verifikasi</th>
                      <th class="text-left px-2 py-1.5">Keterangan</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="prepTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Checklist Operasional -->
          <section id="section-cleaning" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Checklist Operasional</h2>
              <p class="text-xs sm:text-sm text-slate-600">Checklist kebersihan area, grooming karyawan, pengecekan equipment, test produk, dan after closing.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Tambah Checklist</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="cleanOutletName" class="font-medium">-</span></span>
              </div>
              <form id="cleanForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div class="md:col-span-6">
                  <label class="block mb-1">Kategori</label>
                  <select id="cleanCategory" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="Cleaning">Cleaning Area</option>
                    <option value="Grooming">Grooming Karyawan</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Test produk">Test Produk</option>
                    <option value="After Closing">After Closing</option>
                  </select>
                </div>
                <div class="md:col-span-6">
                  <label class="block mb-1">Daftar item checklist</label>
                  <div id="cleanItemsList" class="border border-slate-300 rounded-lg max-h-56 overflow-auto bg-slate-50/40 p-2 space-y-1.5 text-[11px]">
                    <div class="text-slate-500">Pilih kategori untuk menampilkan item checklist.</div>
                  </div>
                </div>
                <div class="hidden">
                  <label class="block mb-1">Tanggal</label>
                  <input id="cleanDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Checklist</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3">
                  <h3 class="text-sm font-semibold">Checklist</h3>
                  <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-600">
                    <div class="flex items-center gap-1">
                      <span>Tanggal:</span>
                      <input id="cleanFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                    </div>
                    <div class="flex items-center gap-1">
                      <span>Kategori:</span>
                      <select id="cleanFilterCategory" class="border border-slate-300 rounded-lg px-2.5 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                        <option value="">Semua</option>
                        <option value="Cleaning">Cleaning Area</option>
                        <option value="Grooming">Grooming Karyawan</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Test produk">Test Produk</option>
                        <option value="After Closing">After Closing</option>
                      </select>
                    </div>
                  </div>
                </div>
                <span class="text-[11px] text-slate-600" id="cleanCountLabel">0 item</span>
              </div>
              <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Tanggal</th>
                      <th class="text-left px-2 py-1.5">Area/Item</th>
                      <th class="text-left px-2 py-1.5">Kategori</th>
                      <th class="text-left px-2 py-1.5">Hasil</th>
                      <th class="text-left px-2 py-1.5">Perbaikan</th>
                      <th class="text-left px-2 py-1.5">Status</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="cleanTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Schedule -->
          <section id="section-schedule" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Jadwal Kerja Karyawan</h2>
              <p class="text-xs sm:text-sm text-slate-600">Atur jadwal kerja periode 21 - 20 bulan berikutnya untuk setiap outlet.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
                <h3 class="text-sm font-semibold">Tambah Jadwal</h3>
                <div class="flex flex-col items-end text-[11px] text-slate-600">
                  <div class="flex items-center gap-2">
                    <label for="scheduleMonth">Periode dimulai bulan:</label>
                    <input id="scheduleMonth" type="month" class="bg-white border border-slate-300 rounded-lg px-2.5 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                  </div>
                  <div id="schedulePeriodLabel" class="mt-1 text-[11px] text-slate-600">
                    Periode: -
                  </div>
                </div>
              </div>
              <form id="scheduleForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div class="md:col-span-2">
                  <label class="block mb-1">Nama Karyawan</label>
                  <input id="scheduleName" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Nama" />
                </div>
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="scheduleDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Shift</label>
                  <select id="scheduleShift" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih shift...</option>
                    <option value="P">P</option>
                    <option value="M">M</option>
                    <option value="S">S</option>
                    <option value="FT">FT</option>
                    <option value="FT1">FT1</option>
                    <option value="FT2">FT2</option>
                    <option value="Off">Off</option>
                    <option value="Cuti">Cuti</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Posisi</label>
                  <input id="scheduleRole" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Server, cook, bar, kasir" />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Jadwal</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold">Kalender Jadwal</h3>
                <div class="flex items-center gap-2">
                  <span class="text-[11px] text-slate-600" id="scheduleCountLabel">0 shift</span>
                  <button id="scheduleExportXlsBtn" type="button" class="px-2.5 py-1.5 rounded-lg border border-slate-300 bg-white text-[11px] text-slate-700 hover:bg-slate-50">
                    Export XLS
                  </button>
                </div>
              </div>
              <p class="text-[11px] text-slate-600 mb-2">
                Periode mengikuti pilihan bulan di atas (21 sampai 20 bulan berikutnya).
              </p>
              <div id="scheduleCalendar" class="overflow-auto text-[11px] sm:text-xs">
                <!-- Diisi oleh JavaScript -->
              </div>
            </div>
          </section>

          <!-- Tasks -->
          <section id="section-tasks" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Tugas Harian Karyawan</h2>
              <p class="text-xs sm:text-sm text-slate-600">Buat daftar tugas harian per orang agar tanggung jawab jelas setiap hari.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Tambah Tugas Harian</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="tasksOutletName" class="font-medium">-</span></span>
              </div>
              <form id="tasksForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="tasksDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Nama Karyawan</label>
                  <select id="tasksName" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 text-xs bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60">
                    <option value="">Pilih karyawan dari jadwal</option>
                  </select>
                </div>
                <div class="md:col-span-3">
                  <label class="block mb-1">Deskripsi Tugas</label>
                  <select id="tasksDesc" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 text-xs bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60">
                    <option value="">Pilih tugas...</option>
                    <option value="Kasir">Kasir</option>
                    <option value="Juicer">Juicer</option>
                    <option value="Order barang">Order barang</option>
                    <option value="Terima barang">Terima barang</option>
                    <option value="Buang sampah">Buang sampah</option>
                    <option value="Diswasher">Diswasher</option>
                    <option value="Sop-sopan">Sop-sopan</option>
                    <option value="Oriental">Oriental</option>
                    <option value="Checker">Checker</option>
                  </select>
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Tugas</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                  <h3 class="text-sm font-semibold">Daftar Tugas</h3>
                  <div class="flex items-center gap-1 text-[11px] text-slate-600">
                    <span>Tanggal:</span>
                    <input id="tasksFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                  </div>
                </div>
                <span class="text-[11px] text-slate-600" id="tasksCountLabel">0 tugas</span>
              </div>
              <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Tanggal</th>
                      <th class="text-left px-2 py-1.5">Nama</th>
                      <th class="text-left px-2 py-1.5">Tugas</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tasksTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Feedback -->
          <section id="section-feedback" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Customer Feedback</h2>
              <p class="text-xs sm:text-sm text-slate-600">Rekap feedback pelanggan dari Google Review, WA Customer Care, Instagram, dan channel lain.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
                <h3 class="text-sm font-semibold">Tambah Feedback</h3>
                <div class="text-[11px] text-slate-600">Outlet: <span id="fbOutletName" class="font-medium">-</span></div>
              </div>
              <form id="fbForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="fbDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Sumber</label>
                  <select id="fbChannel" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60">
                    <option value="Google Review">Google Review</option>
                    <option value="WhatsApp CS">WhatsApp Customer Care</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Nama Pelanggan</label>
                  <input id="fbCustomer" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" placeholder="Opsional" />
                </div>
                <div>
                  <label class="block mb-1">Rating</label>
                  <select id="fbRating" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60">
                    <option value="5">5 - Sangat puas</option>
                    <option value="4">4 - Puas</option>
                    <option value="3">3 - Cukup</option>
                    <option value="2">2 - Kurang</option>
                    <option value="1">1 - Tidak puas</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Kategori</label>
                  <select id="fbCategory" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60">
                    <option value="">Pilih kategori...</option>
                  </select>
                </div>
                <div class="md:col-span-3">
                  <label class="block mb-1">Komentar</label>
                  <input id="fbComment" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" placeholder="Ringkasan komentar pelanggan" />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Feedback</button>
                </div>
              </form>
            </div>

            <div class="space-y-4 lg:space-y-5">
              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                    <h3 class="text-sm font-semibold">Daftar Feedback</h3>
                    <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-600">
                      <div class="flex items-center gap-1">
                        <span>Tanggal:</span>
                        <input id="fbFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                      </div>
                      <div class="flex items-center gap-1">
                        <span>Sumber:</span>
                        <select id="fbFilterChannel" class="border border-slate-300 rounded-lg px-2.5 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                          <option value="">Semua sumber</option>
                          <option value="Google Review">Google Review</option>
                          <option value="WhatsApp CS">WhatsApp Customer Care</option>
                          <option value="Instagram">Instagram</option>
                          <option value="Lainnya">Lainnya</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <span class="text-[11px] text-slate-600" id="fbCountLabel">0 feedback</span>
                </div>
                <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                  <table class="min-w-full border-separate border-spacing-y-1">
                    <thead class="text-[11px] uppercase text-slate-600">
                      <tr>
                        <th class="text-left px-2 py-1.5">Tanggal</th>
                        <th class="text-left px-2 py-1.5">Sumber</th>
                        <th class="text-left px-2 py-1.5">Pelanggan</th>
                        <th class="text-left px-2 py-1.5">Rating</th>
                        <th class="text-left px-2 py-1.5">Kategori</th>
                        <th class="text-left px-2 py-1.5">Komentar</th>
                        <th class="text-right px-2 py-1.5">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="fbTableBody"></tbody>
                  </table>
                </div>
              </div>

              <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm space-y-3 text-[11px] sm:text-xs">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Ringkasan Rating</h3>
                  <span class="text-[11px] text-slate-600">Realtime dari input di atas</span>
                </div>
                <div class="space-y-1.5">
                  <div class="flex items-center justify-between">
                    <span>Rata-rata rating</span>
                    <span id="fbAvgRating" class="font-semibold text-emerald-700">-</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Jumlah review</span>
                    <span id="fbTotalRating" class="font-semibold">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Rating 4-5 (positif)</span>
                    <span id="fbPositiveCount" class="font-semibold text-sky-700">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Rating 1-2 (butuh perhatian)</span>
                    <span id="fbNegativeCount" class="font-semibold text-red-700">0</span>
                  </div>
                </div>
                <p class="text-slate-600 border-t border-slate-200 pt-2 mt-1">Untuk integrasi otomatis dengan Google Review / WA / IG, sistem ini bisa dihubungkan dengan API di tahap pengembangan selanjutnya. Saat ini pencatatan manual dulu.</p>
              </div>
            </div>
          </section>

          <!-- Reject Items -->
          <section id="section-rejects" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Barang Reject</h2>
              <p class="text-xs sm:text-sm text-slate-600">Catat barang yang direject (rusak, kadaluarsa, salah kirim, dll.) dan pantau penyebabnya.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Tambah Barang Reject</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="rejectOutletName" class="font-medium">-</span></span>
              </div>
              <form id="rejectForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div class="md:col-span-2">
                  <label class="block mb-1">Pilih Item</label>
                  <select id="rejectItem" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih item...</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="rejectDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Qty Reject</label>
                  <input id="rejectQty" type="number" step="0.01" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Alasan</label>
                  <select id="rejectReason" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih alasan...</option>
                    <option value="Kadaluarsa">Kadaluarsa</option>
                    <option value="Rusak">Rusak</option>
                    <option value="Salah kirim">Salah kirim</option>
                    <option value="Kualitas tidak sesuai">Kualitas tidak sesuai</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">PIC</label>
                  <input id="rejectPic" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Nama" />
                </div>
                <div class="md:col-span-6">
                  <label class="block mb-1">Keterangan</label>
                  <input id="rejectNote" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Contoh: ditemukan saat stock opname, retur ke supplier, dll." />
                </div>
                <div class="md:col-span-2 flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Reject</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                  <h3 class="text-sm font-semibold">Riwayat Barang Reject</h3>
                  <div class="flex items-center gap-1 text-[11px] text-slate-600">
                    <span>Tanggal:</span>
                    <input id="rejectFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                  </div>
                </div>
                <span class="text-[11px] text-slate-600" id="rejectCountLabel">0 catatan</span>
              </div>
              <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Tanggal</th>
                      <th class="text-left px-2 py-1.5">Item</th>
                      <th class="text-left px-2 py-1.5">Qty</th>
                      <th class="text-left px-2 py-1.5">Alasan</th>
                      <th class="text-left px-2 py-1.5">PIC</th>
                      <th class="text-left px-2 py-1.5">Keterangan</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="rejectTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Log Book -->
          <section id="section-logbook" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Log Book</h2>
              <p class="text-xs sm:text-sm text-slate-600">Buku komunikasi untuk mencatat kejadian penting, tindakan, dan hal yang perlu diteruskan ke shift berikutnya.</p>
            </header>

            <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Tambah Catatan Log Book</h3>
                <span class="text-[11px] text-slate-600">Outlet: <span id="logOutletName" class="font-medium">-</span></span>
              </div>
              <form id="logForm" class="grid gap-3 md:grid-cols-6 text-xs">
                <div>
                  <label class="block mb-1">Tanggal</label>
                  <input id="logDate" type="date" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                </div>
                <div>
                  <label class="block mb-1">Shift</label>
                  <select id="logShift" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="">Pilih shift...</option>
                    <option value="P">P</option>
                    <option value="M">M</option>
                    <option value="S">S</option>
                    <option value="FT">FT</option>
                    <option value="FT1">FT1</option>
                    <option value="FT2">FT2</option>
                    <option value="Off">Off</option>
                    <option value="Cuti">Cuti</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1">Penulis</label>
                  <input id="logAuthor" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Nama yang menulis" />
                </div>
                <div class="md:col-span-3">
                  <label class="block mb-1">Judul Singkat</label>
                  <input id="logTitle" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Ringkasan topik, mis: Komplain meja 12" />
                </div>
                <div class="md:col-span-6">
                  <label class="block mb-1">Isi Catatan / Kejadian</label>
                  <textarea id="logContent" rows="3" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60 resize-y" placeholder="Detail kejadian, tindakan yang sudah diambil, hal yang perlu dicek shift berikutnya..."></textarea>
                </div>
                <div class="md:col-span-6 flex items-center justify-between flex-wrap gap-2">
                  <div class="flex items-center gap-2 text-[11px] text-slate-600">
                    <label class="inline-flex items-center gap-1">
                      <input id="logForNextShift" type="checkbox" class="border border-slate-300 rounded" />
                      <span>Tandai penting untuk shift berikutnya</span>
                    </label>
                  </div>
                  <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Simpan Catatan</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                  <h3 class="text-sm font-semibold">Riwayat Log Book</h3>
                  <div class="flex items-center gap-1 text-[11px] text-slate-600">
                    <span>Tanggal:</span>
                    <input id="logFilterDate" type="date" class="border border-slate-300 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" />
                  </div>
                </div>
                <span class="text-[11px] text-slate-600" id="logCountLabel">0 catatan</span>
              </div>
              <div class="overflow-auto max-h-[320px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Tanggal</th>
                      <th class="text-left px-2 py-1.5">Shift</th>
                      <th class="text-left px-2 py-1.5">Penulis</th>
                      <th class="text-left px-2 py-1.5">Judul</th>
                      <th class="text-left px-2 py-1.5">Catatan</th>
                      <th class="text-left px-2 py-1.5">Untuk Shift Berikutnya</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Checklist Settings (Admin) -->
          <section id="section-checklists" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Pengaturan Checklist (Admin)</h2>
              <p class="text-xs sm:text-sm text-slate-600">Kelola daftar item checklist untuk Cleaning Area, Grooming Karyawan, dan Equipment. Hanya admin yang bisa mengubah.</p>
            </header>

            <div class="bg-white border border-emerald-200 rounded-2xl p-4 shadow-sm space-y-3">
              <h3 class="text-sm font-semibold">Tambah Item Checklist</h3>
              <form id="checklistForm" class="grid gap-3 md:grid-cols-5 text-xs">
                <div>
                  <label class="block mb-1">Kategori</label>
                  <select id="checklistCategory" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="Cleaning">Cleaning Area</option>
                    <option value="Grooming">Grooming Karyawan</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Test produk">Test Produk</option>
                    <option value="After Closing">After Closing</option>
                  </select>
                </div>
                <div class="md:col-span-3">
                  <label class="block mb-1">Nama Item Checklist</label>
                  <input id="checklistName" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60" placeholder="Contoh: Lantai area dining" />
                </div>
                <div class="flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Tambah Item</button>
                </div>
              </form>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold">Daftar Item Checklist</h3>
                <div class="flex items-center gap-2 text-[11px] text-slate-600">
                  <span>Pilih kategori:</span>
                  <select id="checklistFilterCategory" class="border border-slate-300 rounded-lg px-2.5 py-1.5 text-[11px] bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus:border-emerald-500/60">
                    <option value="Cleaning">Cleaning Area</option>
                    <option value="Grooming">Grooming Karyawan</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Test produk">Test Produk</option>
                    <option value="After Closing">After Closing</option>
                  </select>
                </div>
              </div>
              <div class="overflow-auto max-h-[360px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Kategori</th>
                      <th class="text-left px-2 py-1.5">Item Checklist</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="checklistTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Outlet Settings (Admin) -->
          <section id="section-outlets" class="space-y-4 lg:space-y-5 hidden">
            <header class="space-y-1">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight">Pengaturan Outlet (Admin)</h2>
              <p class="text-xs sm:text-sm text-slate-600">Hanya admin (password: 2015115650MR) yang bisa menambah, mengubah, dan menghapus outlet. Maksimal 100 outlet.</p>
            </header>

            <div class="bg-white border border-emerald-200 rounded-2xl p-4 shadow-sm space-y-3">
              <h3 class="text-sm font-semibold">Tambah Outlet Baru</h3>
              <form id="outletForm" class="grid gap-3 md:grid-cols-5 text-xs">
                <div class="md:col-span-2">
                  <label class="block mb-1">Nama Outlet</label>
                  <input id="outletName" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" placeholder="Contoh: Outlet Pusat, Outlet Mall X" />
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1">Lokasi / Kota</label>
                  <input id="outletLocation" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 focus;border-emerald-500/60" placeholder="Contoh: Jakarta Selatan" />
                </div>
                <div class="flex items-end">
                  <button type="submit" class="w-full md:w-auto px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">Tambah Outlet</button>
                </div>
              </form>
              <p class="text-[11px] text-slate-600">Jumlah outlet saat ini: <span id="outletCountLabel">0</span> / 100.</p>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-3.5 sm:p-4 shadow-sm overflow-hidden">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold">Daftar Outlet</h3>
                <span class="text-[11px] text-slate-600">Klik edit/hapus untuk mengelola outlet.</span>
              </div>
              <div class="overflow-auto max-h-[360px] text-[11px] sm:text-xs">
                <table class="min-w-full border-separate border-spacing-y-1">
                  <thead class="text-[11px] uppercase text-slate-600">
                    <tr>
                      <th class="text-left px-2 py-1.5">Kode</th>
                      <th class="text-left px-2 py-1.5">Nama Outlet</th>
                      <th class="text-left px-2 py-1.5">Lokasi</th>
                      <th class="text-right px-2 py-1.5">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="outletTableBody"></tbody>
                </table>
              </div>
            </div>

            <div class="bg-white border border-emerald-200 rounded-2xl p-3.5 sm:p-4 shadow-sm space-y-2 text-[11px] sm:text-xs">
              <div class="flex items-center justify-between mb-1">
                <h3 class="text-sm font-semibold">Backup & Restore Data (Admin)</h3>
                <span class="text-[11px] text-slate-600">Backup manual via file JSON / Google Sheets</span>
              </div>
              <p class="text-slate-600">Gunakan fitur ini untuk menyimpan salinan semua data (semua outlet, inventori, jadwal, tugas, feedback, log book, dll.) ke dalam satu file JSON atau mengirimkannya ke Google Sheets melalui Web App Apps Script. File JSON bisa Anda upload dan simpan di Google Drive sebagai database/backup. Saat diperlukan, file yang sama bisa di-import kembali ke aplikasi ini.</p>
              <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                <button id="backupDownloadBtn" type="button" class="px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-[11px] font-medium transition">Download Backup (JSON)</button>
                <div class="flex items-center gap-2">
                  <label for="backupUploadInput" class="px-3 py-2 rounded-lg border border-slate-300 bg-white text-[11px] font-medium text-slate-700 cursor-pointer hover:bg-slate-50 transition">Import Backup (JSON)</label>
                  <input id="backupUploadInput" type="file" accept="application/json" class="hidden" />
                </div>
                <button id="backupToSheetsBtn" type="button" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white text-[11px] font-medium transition">Backup ke Google Sheets</button>
              </div>
              <p class="text-[11px] text-slate-500">Rekomendasi penggunaan: download backup JSON ini secara berkala lalu simpan di Google Drive (misalnya folder khusus). Untuk restore, download kembali file JSON dari Google Drive ke perangkat ini lalu gunakan tombol Import. Untuk arsip online terpusat, gunakan tombol Backup ke Google Sheets (pastikan URL Web App sudah dikonfigurasi di kode).</p>
            </div>
          </section>
        </section>
      </div>
    </main>

  </div>

  <script>
    const ADMIN_PASSWORD = "2015115650MR";
    // Password Kepala Cabang per outlet (bisa Anda sesuaikan). Jika outletId tidak ada di sini,
    // maka akan menggunakan nilai default.
    const HEAD_PASSWORDS = {
      default: "2015115650MR", // ganti ini jika ingin password kepala cabang berbeda dari admin
      "OUT-1": "065",
      "OUT-2": "046",
      "OUT-3": "033",
      "OUT-4": "024",
      "OUT-5": "035",
      "OUT-6": "073",
      "OUT-7": "059",
      "OUT-8": "044",
      "OUT-9": "038",
      "OUT-10": "sentul",
      "OUT-11": "022",
      "OUT-12": "028",
      "OUT-13": "013",
      "OUT-14": "071",
      "OUT-15": "015",
      "OUT-16": "201",
      "OUT-17": "062",
      "OUT-18": "036",
      "OUT-19": "040",
      "OUT-20": "069",
      "OUT-21": "mm1c",
      "OUT-22": "pk1c",
      "OUT-23": "074",
      "OUT-24": "075",
      "OUT-25": "001",
      "OUT-26": "054",
      "OUT-27": "031",
      "OUT-28": "eka",
      "OUT-29": "068",
      "OUT-30": "008",
      "OUT-31": "puri",
      "OUT-32": "018",
      "OUT-33": "010",
      "OUT-34": "007",
      "OUT-35": " ",
      "OUT-36": " ",
      "OUT-37": "052",
      "OUT-38": "078",
      "OUT-39": "043",
      "OUT-40": "025",
      "OUT-41": "056",
      "OUT-42": "042",
      "OUT-43": "057",
      "OUT-44": "053",
      "OUT-45": "064",
      "OUT-46": "005",
      "OUT-47": "017",
      "OUT-48": "037",
      "OUT-49": "049",
      "OUT-50": "029",
      "OUT-51": "020",
      "OUT-52": "047",
      "OUT-53": "061",
      "OUT-54": "063",
      "OUT-55": "079",
      "OUT-56": "058",
      "OUT-57": "051",
      "OUT-58": "048",
      "OUT-59": "003",
      "OUT-60": "034",
      "OUT-61": "067",
      "OUT-62": "004",
      "OUT-63": "026",
      "OUT-64": "MKS",
      "OUT-65": " ",
      "OUT-66": " ",
      "OUT-67": "009",
      "OUT-68": "055",
    };

    // Konfigurasi Area Manager per wilayah: daftar outlet & password.
    // Struktur: key wilayah -> { outlets: ["OUT-1", ...], password: "Nama/PIN Area Manager" }
    const AREA_MANAGER_REGIONS = {
      jkt1: { outlets: ["OUT-1", "OUT-2", "OUT-3", "OUT-4"], password: "Hartadi" },
      jkt2: { outlets: ["OUT-5", "OUT-6", "OUT-7", "OUT-8"], password: "Darwanto" },
      jkt3: { outlets: ["OUT-9", "OUT-10", "OUT-11", "OUT-12", "OUT-68"], password: "Suprianto" },
      jkt4: { outlets: ["OUT-13", "OUT-14", "OUT-15", "OUT-16"], password: "Deni Hermansyah" },
      jkt5: { outlets: ["OUT-17", "OUT-18", "OUT-19"], password: "Budi Hari Santoso" },
      jkt6: { outlets: ["OUT-20", "OUT-21", "OUT-22", "OUT-23", "OUT-24"], password: "Pujianto" },
      jkt7: { outlets: ["OUT-25", "OUT-26", "OUT-27", "OUT-28"], password: "Badrudin" },
      jkt8: { outlets: ["OUT-29", "OUT-30", "OUT-31"], password: "Tri Prasetio" },
      jkt9: { outlets: ["OUT-32", "OUT-33", "OUT-34", "OUT-66", "OUT-67"], password: "Ahmad Fauzi" },
      bdg:  { outlets: ["OUT-37", "OUT-38", "OUT-39", "OUT-40", "OUT-41"], password: "Dadan Dani" },
      bali: { outlets: ["OUT-41", "OUT-42", "OUT-43", "OUT-44", "OUT-45", "OUT-46", "OUT-47", "OUT-48", "OUT-49", "OUT-50", "OUT-51", "OUT-52", "OUT-53", "OUT-54", "OUT-55", "OUT-56", "OUT-57", "OUT-58"], password: "Ferdianto" },
      bali1: { outlets: ["OUT-41", "OUT-42", "OUT-43", "OUT-44"], password: "Afifur Rahman" },
      bali2: { outlets: ["OUT-45", "OUT-46", "OUT-47", "OUT-48"], password: "Sunarto" },
      bali3: { outlets: ["OUT-49", "OUT-50", "OUT-51", "OUT-52"], password: "Imam Ma'ruf Nahi Mungkar" },
      bali4: { outlets: ["OUT-53", "OUT-54", "OUT-55", "OUT-56"], password: "I Made Swastika" },
      surabaya: { outlets: ["OUT-59", "OUT-60", "OUT-61", "OUT-62", "OUT-63", "OUT-64", "OUT-65"], password: "Khoirrudin" },
    };

    const STORAGE_KEY = "restoOpsHubState_v1";
    // Ganti string berikut dengan URL Web App Google Apps Script Anda
    const GOOGLE_SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxk_Y1MxWBMJ4RCH9IXplrIHs_vW-uUotYNXHlV9mcoT-dzptLonxhaRQHyGaOmdBO5/exec"; // contoh: "https://script.google.com/macros/s/AKfycbxxxx/exec"

    let state = null;
    let currentSection = "dashboard";

    function createBaseState() {
      return {
        // role: 'karyawan' | 'kepala' | 'area' | 'admin'
        role: 'karyawan',
        isAdmin: false,
        areaRegion: null,
        selectedOutletId: null,
        outlets: [
          { id: "OUT-1", name: "MM RS Mayapada Tangerang", location: "Jabodetabek" },
          { id: "OUT-2", name: "MM RS Carolus Sumarecon", location: "Jabodetabek" },
          { id: "OUT-3", name: "MM RS EMC Alam Sutera", location: "Jabodetabek" },
          { id: "OUT-4", name: "MM RS JEC Kedoya", location: "Jabodetabek" },
          { id: "OUT-5", name: "MM Bandara Soetta T 1B Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-6", name: "MM Bandara Soetta T 2E Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-7", name: "MM Bandara Soetta T 2F Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-8", name: "MM Bandara Soetta T 3Int Kedatangan", location: "Jabodetabek" },
          { id: "OUT-9", name: "MM RS Siloam Cikarang", location: "Jabodetabek" },
          { id: "OUT-10", name: "MM RS EMC Sentul", location: "Jabodetabek" },
          { id: "OUT-11", name: "MM Green Terrace TMII", location: "Jabodetabek" },
          { id: "OUT-12", name: "MM Villagio Sumarecon Karawang", location: "Jabodetabek" },
          { id: "OUT-13", name: "MM RS Premier Bintaro", location: "Jabodetabek" },
          { id: "OUT-14", name: "MM RS Mayapada Kuningan", location: "Jabodetabek" },
          { id: "OUT-15", name: "MM Plaza Bintaro", location: "Jabodetabek" },
          { id: "OUT-16", name: "MM HO Fatmawati", location: "Jabodetabek" },
          { id: "OUT-17", name: "MM Cikajang", location: "Jabodetabek" },
          { id: "OUT-18", name: "MM Hypermart Taman Yasmin", location: "Jabodetabek" },
          { id: "OUT-19", name: "MM RSUP Fatmawati", location: "Jabodetabek" },
          { id: "OUT-20", name: "MM Bandara Soetta T 1A Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-21", name: "MM Bandara Soetta T 1C Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-22", name: "PK Bandara Soetta T 1C Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-23", name: "MM Bandara Soetta T 3 Gate 3 Kedatangan", location: "Jabodetabek" },
          { id: "OUT-24", name: "MM Bandara Soetta T 3 Gate 14 Keberangkatan", location: "Jabodetabek" },
          { id: "OUT-25", name: "MM Melawai", location: "Jabodetabek" },
          { id: "OUT-26", name: "MM RS Pusat Pertamina", location: "Jabodetabek" },
          { id: "OUT-27", name: "MM RS Hermina Kemayoran", location: "Jabodetabek" },
          { id: "OUT-28", name: "MM EKA Hospital MT. Haryono", location: "Jabodetabek" },
          { id: "OUT-29", name: "MM RSPAD Gatot Soebroto", location: "Jabodetabek" },
          { id: "OUT-30", name: "MM RS Pantai Indah Kapuk", location: "Jabodetabek" },
          { id: "OUT-31", name: "MM Mal Puri Indah", location: "Jabodetabek" },
          { id: "OUT-32", name: "MM Pandansari", location: "Jabodetabek" },
          { id: "OUT-33", name: "MM RS Mayapada Jaksel", location: "Jabodetabek" },
          { id: "OUT-34", name: "PK RS Mayapada Jaksel", location: "Jabodetabek" },
          { id: "OUT-35", name: "MM RS EMC Pekayon", location: "Jabodetabek" },
          { id: "OUT-36", name: "MM RS Mayapada Cakung", location: "Jabodetabek" },
          { id: "OUT-37", name: "MM RS Hasan Sadikin Bandung", location: "Bandung" },
          { id: "OUT-38", name: "MM RS Mayapda Bandung", location: "Bandung" },
          { id: "OUT-39", name: "MM Paris Van Java", location: "Bandung" },
          { id: "OUT-40", name: "MM Sumarecon Mal Bandung", location: "Bandung" },
          { id: "OUT-41", name: "MM Paskal 23 Bandung", location: "Bandung" },
          { id: "OUT-42", name: "MM Living World Bali", location: "Bali" },
          { id: "OUT-43", name: "PK Living World Bali", location: "Bali" },
          { id: "OUT-44", name: "MM Gatot Soebroto", location: "Bali" },
          { id: "OUT-45", name: "MM RSUP Prof. Dr. I.G.N.G. Ngoerah", location: "Bali" },
          { id: "OUT-46", name: "MM RS Kasih Ibu", location: "Bali" },
          { id: "OUT-47", name: "MM Lippo Plaza Sunset", location: "Bali" },
          { id: "OUT-48", name: "MM Icon Bali", location: "Bali" },
          { id: "OUT-49", name: "PK Icon Bali", location: "Bali" },
          { id: "OUT-50", name: "MM Mal Bali Galeria", location: "Bali" },
          { id: "OUT-51", name: "PK Mal Bali Galeria", location: "Bali" },
          { id: "OUT-52", name: "MM Lippo Mal Kuta", location: "Bali" },
          { id: "OUT-53", name: "MM Plaza Renon", location: "Bali" },
          { id: "OUT-54", name: "MM Beachwalk", location: "Bali" },
          { id: "OUT-55", name: "PK Beachwalk", location: "Bali" },
          { id: "OUT-56", name: "MM Teuku Umar", location: "Bali" },
          { id: "OUT-57", name: "MM Mega Mas Manado", location: "Manado" },
          { id: "OUT-58", name: "MM Manado Town Square", location: "Manado" },
          { id: "OUT-59", name: "MM Grand City Surabaya", location: "Surabaya" },
          { id: "OUT-60", name: "MM Bandara Juanda", location: "Surabaya" },
          { id: "OUT-61", name: "MM RS Mayapada Surabaya", location: "Surabaya" },
          { id: "OUT-62", name: "MM RS Mitra Keluarga Waru", location: "Surabaya" },
          { id: "OUT-63", name: "MM RS Husada Utama", location: "Surabaya" },
          { id: "OUT-64", name: "MM RS Mitra Keluarga Sidoarjo", location: "Surabaya" },
          { id: "OUT-65", name: "MM RS Mitra Keluarga Darmo Satelit", location: "Surabaya" },
          { id: "OUT-66", name: "MM Bandar Udara Sultan Hasanudin Keberangkatan", location: "Makasar" },
          { id: "OUT-67", name: "MM Bandar Udara Sultan Hasanudin Kedatangan", location: "Makasar" },
          { id: "OUT-68", name: "MM RS Mayapada Nusantara", location: "IKN" },
        ],
        inventory: {},
        stockOut: {},
        prep: {},
        cleaning: {},
        schedules: {},
        tasks: {},
        feedback: {},
        rejects: {},
        quickNotes: {},
        logbook: {},
      };
    }

    function ensureOutletContainers(outletId) {
      if (!state.inventory[outletId]) state.inventory[outletId] = [];
      if (!state.stockOut[outletId]) state.stockOut[outletId] = [];
      if (!state.prep[outletId]) state.prep[outletId] = [];
      if (!state.cleaning[outletId]) state.cleaning[outletId] = [];
      if (!state.schedules[outletId]) state.schedules[outletId] = [];
      if (!state.tasks[outletId]) state.tasks[outletId] = [];
      if (!state.feedback[outletId]) state.feedback[outletId] = [];
      if (!state.rejects[outletId]) state.rejects[outletId] = [];
      if (!state.quickNotes[outletId]) state.quickNotes[outletId] = "";
      if (!state.logbook[outletId]) state.logbook[outletId] = [];
    }

    const CLEAN_CATEGORY_ITEMS = {
      Cleaning: [
        "Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang khusus bagi cabang yang meminta barang ke gudang di siang hari",
        "Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan",
        "Rekap Pemakaian sudah dikerjakan dan dikirim kebagian akuntasi",
        "Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi",
        "Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi",
        "Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup",
        "Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan",
        "Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup ",
        "Kain Lap Meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap",
        "Kain Lap Sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap",
        "Hand sanitizer pada posisi pintu masuk & kasir",
        "Disinfektan tersedia dalam kondisi cukup",
        "Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi",
        "Semua pegangan pintu, pegangan anak tangga, pembatas antrian, standing menu dalam kondisi bersih",
        "Washtafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin",
        "Tempat sampah semua area dalam kondisi tidak overload, tidak ada bau tidak sedap dan body bersih",
        "Pad counter dalam kondisi bersih dan barang-barang tertata rapi",
        "Semua Dinding (dinning, juicer, kasir, dapur, gudang) dalam kondisi bersih",
        "Semua lantai (dinning, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih",
        "Kaca (jendela, interior) dalam kondisi bersih tidak buram",
        "Difuser AC / AC dalam kondisi bersih dan dingin",
        "TV display, Audio player dalam kondisi normal dan bersih",
        "Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih",
        "Service Extention dalam kondisi rapi dan bersih",
        "Lampu (dinning, box menu, Logo) dalam kondisi menyala normal dan bersih",
        "Tanaman Hias tidak ada yang layu daunnya dan dalam kondisi berdebu",
        "Sarana Promosi (x benner, tripod benner, standing menu, baliho) dalam kondisi layak dan bersih",
        "Peralatan proses juicer (Blender, Juicer, extraktor, sendok ukur, pisau, telenan, saringan juice, teh, scope es krim, tea maker, mesin serut es, mesin cup seler, es maker, timbangan) dalam kondisi berfungsi normal dan bersih",
        "Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, luch box, box gurame, paperbowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih",
        "Meja kerja disemua area dalam kondisi bersih dan penataan barang-barang rapi",
        "Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi",
        "Frezzer, under frezzer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi",
        "Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih",
        "Tempat prepare diarea juicer dan dapur (food pan, kitchen set, termos nasi, kranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih",
        "Tempat penyimpanan bahan baku & produk (rak susun, rak tempel, dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi",
        "Sink, grase trap, grase induk dan gutter dalam kondisi bersih",
        "Langit-langit semua area dalam kondisi baik dan bersih",
        "Tempat sampah semua area dalam kondisi tertutup, bersih dan tidak ada bau tidak sedap",
        "Dinding semua area dalam kondisi bersih",
        "Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Hand phone, HT dalam kondisi normal dan bersih",
        "Setor omzet maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan",
        "Kelengkapan peralatan kasir (kalkulator, money detektor, scaner, steplest, isolatif) dalam kondisi cukup",
        "Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)",
        "Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya",
        "Hood dan exchause dalam kondisi bersih dan berfungsi normal",
        "Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal",
        "Semua area bebas dari hama(tikus, kecoa, lalat, semut)",
        "Toilet - Handle pintu dan kunci pintu berfungsi normal dan bersih",
        "Aroma toilet harum atau tidak berbau tidak sedap",
        "Toilet - Lantai dan dinding dalam kondisi bersih dan kering",
        "Toilet - Lampu penerangan tidak ada yang mati dan fan exchause dengan kondisi bersih dan berfungsi normal",
        "Kloset dalam kondisi baik,bersih dan kering",
        "Shower kloset berfungsi normal dan bersih",
        "Washtafel dan cermin dalam kondisi normal dan bersih serta tersedia hand soap dan tissue",
        "Urinor dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap",
        "Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap",
      ],
      Grooming: [
        "Muka bersih tidak berminyak dan merias wajah sesuai standart ",
        "Kulit tidak kering dan tidak bersisik memakai body lotion",
        "Kuku pendek dan tidak menggunakan cat kuku",
        "Bulu atau rambut hidung tidak menjorok keluar lubang hidung",
        "Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat",
        "Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi",
        "Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam konsisi bersih dan mengkilap (bersemir)",
        "Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana",
        "Memakai kaos singlet warna putih",
        "Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya",
        "Tidak ada tato dibagian tubuh yang terbuka",
        "Pakai name tag sesuai standar yang ditetapkan",
        "Memakai masker hitam dan kelengkapan kerja sesuai jabatannya",
        "Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat",
        "Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata",
        "Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab",
        "Dilarang menggunakan jarum pentul",
        "Memakai dalaman hijab berwarna hitam polos",
        "Rambut panjang harus memakai hairnet dan poni tidak menjuntai kedepan menutupi dahi",
      ],
      Equipment: [
        "Chiller berfungsi normal",
        "Freezer berfungsi normal",
        "Salad Case berfungsi normal",
        "Alegro berfungsi normal",
        "Kompor Gas High menyala normal",
        "Kompor Gas Low menyala normal",
        "Kompor Listrik High berfungsi normal",
        "Kompor Listrik Low berfungsi normal",
        "Deep Fryer berfungsi normal",
        "Toaster berfungsi normal",
        "Steamer Siomay berfungsi normal",
        "Gas Cooker/ Rice Cooker berfungsi normal",
        "Exhaust fan berfungsi",
        "Lampu dapur menyala",
        "Lampu dining menyala",
        "Dispenser berfungsi normal",
        "Tea maker berfungsi normal",
        "Mesin es serut berfungsi normal",
        "POS berfungsi normal",
        "Mesin EDC berfungsi normal",
        "Printer struk berfungsi normal",
        "Peralatan juice tersedia lengkap dan berfungsi normal",
        "Cuttlires tersedia lengkap",
        "Peralatan masak tersedia lengkap dan berfungsi normal",
        "Round Tray tersedia lengkap",
        "Alat kebersihan lengkap",
        "APAR tersedia dan layak pakai",
      ],
      "Test produk": [
        "Siomay MM dan pelengkapnya tidak ada rasa asam/basi, bau asem, benyek/keras/lender, warna tidak segar/tidak cerah, dan belum exp",
        "Otak-otak bakar, Pempek MM dan pelengkapnya  tidak ada rasa asam/basi, bau asem, benyek/keras/lender, warna tidak segar/tidak cerah, dan belum exp",
        "Nasi goreng MM, PK dan pelengkapnya tidak ada rasa asam/basi, aroma asem, tesktur tidak benyek/keras, Telur dalam keadaan bersih/layak saji",
        "Sop khas MM, PK dan pelengkapnya tidak ada rasa asam/basi, bau asem, benyek/keras/lender, warna segar/cerah, dan belum exp",
        "Rice bowl MM dan pelengkapnya tidak ada rasa asam/basi, bau asem, benyek/keras/lender, warna segar/cerah",
        "Baso, Baso tahu kuah dan pelengkapnya tidak ada rasa asam/basi, bau asem, benyek/keras/lender, warna tidak segar/tidak cerah, dan belum exp",
        "Mie, Kwetiaw, Bihun MM dan pelengkapnya idak ada rasa asam/basi, bau asem, benyek/keras/lender, warna tidak segar/tidak cerah, dan belum exp",
        "Masakan lain-lain MM, PK dan pelengkapnya rasa tidak basi, aroma tidak asem, tekstur tidak keras/benyek, berlendir",
        "Masakan Vegetarian MM dan pelengkapnya rasa tidak basi, aroma tidak asem, tekstur tidak keras/benyek, berlendir",
        "Snack MM, Camilan Kuring dan pelengkapnya rasa tidak basi, aroma tidak asem, tekstur tidak keras/benyek, berlendir",
        "Fresh juice, Special blend, Special juice, Refreshing drink, other drink and dessert, minuman kuring  dan pelengkapnya rasa tidak basi, aroma tidak asem, kondisi tidak busuk, dan tekstur berlendir, soda masih berkarbonasi",
        "Lauk Kuring dan pelengkapnya rasa tidak basi, aroma tidak asem, tesktur tidak keras/benyek, tidak berlendir",
        "Nasi Kuring, MM tidak benyek/keras, tidak basi, aroma tidak asem, tidak berlendir",
        "Sayur & Sop Kuring rasa tidak basi, aroma tidak asem, tidak berlendir",
        "Sambal MM & Kuring  rasa tidak basi, aroma tidak asem, tidak berlendir",
        "Pepes Kuring rasa tidak basi, aroma tidak asem, tidak berlendir, dan tidak exp",
        "Bahan baku pabrikan belum masuk masa expired date, Food (Baso nasi goreng, Baso sapi, Beras merah, Bihun medan, Cuka, Garam, Gula Palem, Gula pasir, Jamur kaleng, Kaldu bubuk ayam, Kecap manis, Kecap angsa, Keju, Mentega, Mie telur, Mie merah, Mie hijau, Minyak goreng, Minyak wijen, Otak-otak goreng, Roti tawar, S.Sambal, S.Sambal saset, S.Tomat, Sosis sapi, Tofu, Tepung beras, Tepung sagu, Tepung roti, Tepung terigu, Vanili  bubuk), Beverage (Air mineral, Es krim coklat, Es krim strawberry, Es krim vanila, Garam buah, Gula saset, Jelly boba, Jelly rainbow, Kental manis, Kopi bubuk, Madu, Mesis, Nata de coco, Oreo bubuk, PRK, Powder basic cream, Powder taro, Sari kelapa, Sirup Leci, Buah leci, Sirup Lemon, Sirup Mocca, Sirup sakura, Sirup strawberry, Sirup vanila, Soda, Teh bubuk, Teh lipton, Kiamboy, Bunga teleng, Biji selasih, Pewarna ronde, Oat milk, Susu segar, Selai kacang)",
        "Semua bahan baku disimpan sesuai ketentuan yang berlaku (chiller, freezer, suhu ruang) mengikuti standar ketentuan STD-LIT-15",
      ],
      "After Closing": [
        "Permintaan barang ke gudang sudah di lakukan dan diverifikasi oleh kacab atau staff penggantinya",
        "Labeling pada pada barang datang sudah dilakukan",
        "Stock Opname sudah dilakukan dan diinput kedalam form rekapan pemakaian",
        "Bahan baku sisa sudah masuk pendingin (bahan baku food & juice)",
        "Semua peralatan saji dan kerja dalam kondisi bersih (dapur, juicer, kasir, dinning)",
        "Grase Trap dan Gotter dalam kondisi bersih (dapur & juicer)",
        "Semua area dalam kondisi bersih meliputi semua dinding, semua kolong meja kerja, pendingin, meja makan dan bangku dan atau sofa dalam kondisi bersih",
        "Semua area bebas hama (tikus, kecoa, semut, lalat)",
        "Tea maker, Microwave, Toaster, Magic com, Mesin cup sealer, Mesin ice cube, Mesin cuci piring dalam kondisi off",
        "Exaust Pan, Kompor gas, kompor listrik  dalam kondisi off",
        "Valve Gas central, Valve kran air dalam kondisi off",
        "Lampu penerangan dan lampu  hias area dinning, dapur, juicer, kasir serta lampu logo dalam kondisi off",
        "Komputer admin, POS, Semua printer, Monitor checker, UPS dalam kondisi off",
        "Uang Omzet, Kas Kecil, Modal sudah masuk ke brangkas dan kodenya diputar acak",
        "Kipas Angin / AC, TV display, Audio player dalam kondisi off",
        "Tidak ada sampah yang tertinggal di dalam cabang",
        "Semua pintu dan jendela dalam kondisi terkunci",
      ],
    };

    const INVENTORY_ITEM_TEMPLATES = [
      "Ayam Negeri",
      "Ayam Buncis",
      "Ayam Kuning",
      "Ayam Kuning Negeri",
      "Ayam Marinade",
      "BAWANG GORENG",
      "BIANG BUMBU OTAK-OTAK",
      "BIANG BUMBU SIOMAY",
      "BIANG SAMBAL",
      "BIANG SAYUR ASEM",
      "BIANG SOTO AYAM",
      "BONELESS MARINADE",
      "BONELESS TIM",
      "BUMBU ASINAN",
      "BUMBU KALDU RASA",
      "BUMBU MIE AYAM",
      "BUMBU MIE JAWA",
      "BUMBU NASI GORENG",
      "BUMBU TAHU",
      "BUNTUT NASI GORENG",
      "BUNTUT SOP",
      "DURIAN",
      "EBI MATANG",
      "EMPAL",
      "SIOMAY",
      "SIOMAY KEMBANG TAHU",
      "SIOMAY UDANG",
      "SOTO BETAWI",
      "TONGSENG AYAM",
      "TONGSENG SOP",
      "GULA REMPAH",
      "IGA SOP",
      "KACANG GORENG",
      "KECAP MIE AYAM",
      "KECAP OPLOS ( B )",
      "KECAP OPLOS",
      "KELAPA KOPYOR",
      "KERONGKONG AYAM",
      "KUAH CAH",
      "KUAH CAP CAY",
      "KUAH PEMPEK",
      "MINYAK MIE AYAM",
      "OTAK-OTAK BAKAR",
      "PEMPEK KAPAL SELAM",
      "PEMPEK KEJU",
      "PEMPEK LENJERAN",
      "PLETOK SET @1 SET",
      "RISOLES",
      "SAMBAL HIJAU",
      "SAOS KUNGPAO",
      "SAOS TELOR ASIN",
      "SAPI MARINADE",
      "SIRSAK",
      "STROBERI",
      "TEPUNG PREMIX",
      "TERASI MATANG"
    ];

    const INVENTORY_ITEM_DEFAULT_UNITS = {
      "Ayam Negeri": "Kg",
      "Ayam Buncis": "Kg",
      "Ayam Kuning": "Pcs",
      "Ayam Kuning Negeri": "Pcs",
      "Ayam Marinade": "Kg",
      "BAWANG GORENG": "Kg",
      "BIANG BUMBU OTAK-OTAK": "Kg",
      "BIANG BUMBU SIOMAY": "Kg",
      "BIANG SAMBAL": "Kg",
      "BIANG SAYUR ASEM": "Kg",
      "BIANG SOTO AYAM": "Kg",
      "BONELESS MARINADE": "Kg",
      "BONELESS TIM": "Kg",
      "BUMBU ASINAN": "Prs",
      "BUMBU KALDU RASA": "Pcs",
      "BUMBU MIE AYAM": "Kg",
      "BUMBU MIE JAWA": "Kg",
      "BUMBU NASI GORENG": "Kg",
      "BUMBU TAHU": "Prs",
      "BUNTUT NASI GORENG": "Prs",
      "BUNTUT SOP": "Prs",
      "DURIAN": "Prs",
      "EBI MATANG": "Kg",
      "EMPAL": "Pcs",
      "SIOMAY": "Pcs",
      "SIOMAY KEMBANG TAHU": "Pcs",
      "SIOMAY UDANG": "Pcs",
      "SOTO BETAWI": "Prs",
      "TONGSENG AYAM": "Prs",
      "TONGSENG SOP": "Prs",
      "GULA REMPAH": "Prs",
      "IGA SOP": "Prs",
      "KACANG GORENG": "Kg",
      "KECAP MIE AYAM": "Kg",
      "KECAP OPLOS ( B )": "Kg",
      "KECAP OPLOS": "Kg",
      "KELAPA KOPYOR": "Prs",
      "KERONGKONG AYAM": "Kg",
      "KUAH CAH": "Kg",
      "KUAH CAP CAY": "Prs",
      "KUAH PEMPEK": "Kg",
      "MINYAK MIE AYAM": "Kg",
      "OTAK-OTAK BAKAR": "Pcs",
      "PEMPEK KAPAL SELAM": "Pcs",
      "PEMPEK KEJU": "Pcs",
      "PEMPEK LENJERAN": "Pcs",
      "PLETOK SET @1 SET": "Prs",
      "RISOLES": "Pcs",
      "SAMBAL HIJAU": "Kg",
      "SAOS KUNGPAO": "Kg",
      "SAOS TELOR ASIN": "Kg",
      "SAPI MARINADE": "Kg",
      "SIRSAK": "Prs",
      "STROBERI": "Prs",
      "TEPUNG PREMIX": "Kg",
      "TERASI MATANG": "Grm"
    };

    function loadState() {
      const base = createBaseState();
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          state = base;
        } else {
          const parsed = JSON.parse(raw);
          state = Object.assign(base, parsed);
        }
      } catch (e) {
        console.error("Gagal load state, gunakan default", e);
        state = base;
      }

      // Paksa gunakan daftar outlet terbaru dari kode (abaikan outlet lama di localStorage)
      state.outlets = base.outlets;

      // Selalu gunakan template checklist terbaru dari kode (abaikan versi lama di localStorage)
      try {
        state.cleanTemplates = JSON.parse(JSON.stringify(CLEAN_CATEGORY_ITEMS));
      } catch (e) {
        state.cleanTemplates = CLEAN_CATEGORY_ITEMS;
      }

      if (!state.selectedOutletId && state.outlets.length) {
        state.selectedOutletId = state.outlets[0].id;
      }

      state.outlets.forEach((o) => ensureOutletContainers(o.id));
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Gagal simpan state", e);
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
    }

    function todayStr() {
      return new Date().toISOString().slice(0, 10);
    }

    function getSchedulePeriodRange(monthStr) {
      if (!monthStr) return null;
      const parts = monthStr.split("-");
      if (parts.length !== 2) return null;
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      if (!year || !month) return null;

      const start = new Date(year, month - 1, 21);

      let endYear = year;
      let endMonthIndex;
      if (month === 12) {
        endYear = year + 1;
        endMonthIndex = 0; // Januari tahun berikutnya (0-based)
      } else {
        endMonthIndex = month; // bulan berikutnya (0-based)
      }
      const end = new Date(endYear, endMonthIndex, 20);

      return { start, end };
    }

    // Cek libur nasional Indonesia tetap (berdasarkan tanggal bulan-tanggal, tanpa tahun)
    // Catatan: hanya mencakup hari libur dengan tanggal tetap (1 Jan, 1 Mei, 1 Jun, 17 Agu, 25 Des, dll.)
    // Hari besar lain yang berubah setiap tahun (Idul Fitri, Idul Adha, Nyepi, Waisak) tidak dihitung otomatis di sini.
    function isIndonesianHoliday(date) {
      const month = date.getMonth() + 1; // 1-12
      const day = date.getDate();
      const md = `${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const fixedHolidays = new Set([
        "01-01", // Tahun Baru Masehi
        "05-01", // Hari Buruh Internasional
        "06-01", // Hari Lahir Pancasila
        "08-17", // Hari Kemerdekaan RI
        "12-25", // Hari Raya Natal
      ]);
      return fixedHolidays.has(md);
    }

    function renderOutletDropdown() {
      const select = document.getElementById("outletSelect");
      select.innerHTML = "";

      let outlets = state.outlets.slice();

      // Jika peran Area Manager, batasi outlet yang bisa dipilih sesuai wilayahnya
      if (state.role === 'area' && state.areaRegion && AREA_MANAGER_REGIONS[state.areaRegion]) {
        const allowed = new Set(AREA_MANAGER_REGIONS[state.areaRegion].outlets || []);
        outlets = outlets.filter((o) => allowed.has(o.id));
        // Jika outlet terpilih saat ini tidak termasuk, pindahkan ke outlet pertama yang diizinkan
        if (!allowed.has(state.selectedOutletId) && outlets.length) {
          state.selectedOutletId = outlets[0].id;
        }
      }

      outlets.forEach((o) => {
        const opt = document.createElement("option");
        opt.value = o.id;
        opt.textContent = o.name;
        if (o.id === state.selectedOutletId) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function getCurrentOutlet() {
      return state.outlets.find((o) => o.id === state.selectedOutletId) || null;
    }

    function updateAdminUI() {
      const dot = document.getElementById("adminDot");
      const statusText = document.getElementById("adminStatusText");
      const headLoginBtn = document.getElementById("headLoginBtn");
      const areaLoginBtn = document.getElementById("areaLoginBtn");
      const adminLoginBtn = document.getElementById("adminLoginBtn");
      const logoutBtn = document.getElementById("adminLogoutBtn");
      const outletNav = document.getElementById("outletSettingsNav");
      const checklistNav = document.getElementById("checklistSettingsNav");
      const adminDash = document.getElementById('adminGlobalDashboard');

      const role = state.role || 'karyawan';

      // Warna indikator peran
      dot.classList.remove("bg-red-500", "bg-amber-500", "bg-emerald-500", "bg-sky-500");
      if (role === 'admin') {
        dot.classList.add("bg-emerald-500");
        statusText.textContent = "Peran: Admin";
      } else if (role === 'kepala') {
        dot.classList.add("bg-amber-500");
        statusText.textContent = "Peran: Kepala Cabang";
      } else if (role === 'area') {
        dot.classList.add("bg-sky-500");
        statusText.textContent = "Peran: Area Manager";
      } else {
        dot.classList.add("bg-red-500");
        statusText.textContent = "Peran: Karyawan";
      }

      // Visibilitas tombol & menu admin
      if (role === 'admin') {
        if (headLoginBtn) headLoginBtn.classList.add("hidden");
        if (areaLoginBtn) areaLoginBtn.classList.add("hidden");
        if (adminLoginBtn) adminLoginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        outletNav.classList.remove("hidden");
        if (checklistNav) checklistNav.classList.remove("hidden");
      } else if (role === 'kepala' || role === 'area') {
        if (headLoginBtn) headLoginBtn.classList.add("hidden");
        if (areaLoginBtn) areaLoginBtn.classList.add("hidden");
        if (adminLoginBtn) adminLoginBtn.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        // Kepala Cabang & Area Manager TIDAK boleh mengakses menu admin
        outletNav.classList.add("hidden");
        if (checklistNav) checklistNav.classList.add("hidden");
        // Pastikan tidak sedang di halaman Pengaturan Outlet / Checklist jika bukan admin penuh
        if (currentSection === "outlets" || currentSection === "checklists") {
          switchSection("dashboard");
        }
      } else {
        // Karyawan biasa
        if (headLoginBtn) headLoginBtn.classList.remove("hidden");
        if (areaLoginBtn) areaLoginBtn.classList.remove("hidden");
        if (adminLoginBtn) adminLoginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        outletNav.classList.add("hidden");
        if (checklistNav) checklistNav.classList.add("hidden");
        if (currentSection === "outlets" || currentSection === "checklists") {
          switchSection("dashboard");
        }
      }

      // Flag isAdmin dipertahankan untuk kompatibilitas lama (true hanya jika role admin)
      state.isAdmin = role === 'admin';

      // Tampilkan / sembunyikan dashboard global admin
      if (adminDash) {
        if (role === 'admin') adminDash.classList.remove('hidden');
        else adminDash.classList.add('hidden');
      }

      // Render ulang dropdown outlet jika role area agar pembatasan outlet berlaku
      renderOutletDropdown();

      // Atur visibilitas elemen berdasarkan peran
      updateRoleVisibility();

      // Render dashboard global jika sedang admin
      if (role === 'admin') {
        renderAdminDashboardGlobal();
      }
    }

    function updateRoleVisibility() {
      const role = state.role || 'karyawan';

      const hide = (el) => { if (el) el.classList.add('hidden'); };
      const show = (el) => { if (el) el.classList.remove('hidden'); };

      // Kartu/form Tambah Jadwal
      const scheduleFormEl = document.getElementById('scheduleForm');
      const scheduleFormCard = scheduleFormEl ? scheduleFormEl.closest('.bg-white') : null;

      // Kartu/form Tambah Tugas Harian
      const tasksFormEl = document.getElementById('tasksForm');
      const tasksFormCard = tasksFormEl ? tasksFormEl.closest('.bg-white') : null;

      // Kartu/form Tambah Preparation
      const prepFormEl = document.getElementById('prepForm');
      const prepFormCard = prepFormEl ? prepFormEl.closest('.bg-white') : null;

      // Kartu Reset / Bersihkan Data Inventori
      const invCleanupEl = document.getElementById('invCleanupForm');
      const invCleanupCard = invCleanupEl ? invCleanupEl.closest('.bg-white') : null;

      if (role === 'karyawan') {
        // Karyawan: sembunyikan form pengaturan, hanya pakai fungsi operasional harian
        hide(scheduleFormCard);      // Tambah Jadwal
        hide(tasksFormCard);         // Tambah Tugas Harian
        hide(prepFormCard);          // Tambah Batch Preparation
        hide(invCleanupCard);        // Reset / Bersihkan Data Inventori
        // Form lain seperti Tambah Checklist, Tambah Barang Reject, Tambah/Update Inventori,
        // Catat Stok Keluar, Tambah Feedback, Tambah Log Book tetap ditampilkan.
      } else {
        // Kepala & Admin: tampilkan semua form
        show(scheduleFormCard);
        show(tasksFormCard);
        show(prepFormCard);
        show(invCleanupCard);
      }
    }

    function switchSection(section) {
      if ((section === "outlets" || section === "checklists") && !state.isAdmin) {
        alert("Menu ini hanya bisa dibuka oleh admin.");
        return;
      }
      currentSection = section;
      document.querySelectorAll("[id^='section-']").forEach((el) => {
        if (el.id === "section-" + section) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      });
      document.querySelectorAll(".section-tab").forEach((btn) => {
        const target = btn.getAttribute("data-section");
        if (!target) return;
        if (target === section) {
          btn.classList.add("bg-emerald-50", "text-emerald-700");
        } else {
          btn.classList.remove("bg-emerald-50", "text-emerald-700");
        }
      });
    }

    function refreshOutletLabels() {
      const outlet = getCurrentOutlet();
      const name = outlet ? outlet.name : "-";
      const dashOutlet = document.getElementById("dashOutletName");
      if (dashOutlet) dashOutlet.textContent = name;
      const invOutlet = document.getElementById("invOutletName");
      if (invOutlet) invOutlet.textContent = name;
      const stockOutOutlet = document.getElementById("stockOutOutletName");
      if (stockOutOutlet) stockOutOutlet.textContent = name;
      const prepOutlet = document.getElementById("prepOutletName");
      if (prepOutlet) prepOutlet.textContent = name;
      const cleanOutlet = document.getElementById("cleanOutletName");
      if (cleanOutlet) cleanOutlet.textContent = name;
      const tasksOutlet = document.getElementById("tasksOutletName");
      if (tasksOutlet) tasksOutlet.textContent = name;
      const fbOutlet = document.getElementById("fbOutletName");
      if (fbOutlet) fbOutlet.textContent = name;
      const logOutlet = document.getElementById("logOutletName");
      if (logOutlet) logOutlet.textContent = name;
    }

    function renderInventory() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.inventory[outletId];
      const tbody = document.getElementById("inventoryTableBody");
      const countLabel = document.getElementById("invCountLabel");
      const searchInput = document.getElementById("invSearch");
      const typeFilter = document.getElementById("invTypeFilter");
      const term = searchInput ? searchInput.value.trim().toLowerCase() : "";
      const typeVal = typeFilter ? typeFilter.value : "";
      tbody.innerHTML = "";

      // Hitung summary stok (semua item di outlet ini)
      let totalHabis = 0;
      let totalLow = 0;
      data.forEach((item) => {
        const stock = Number(item.stock || 0);
        const minStock = Number(item.minStock || 0);
        if (stock <= 0) {
          totalHabis++;
        } else if (minStock > 0 && stock <= minStock) {
          totalLow++;
        }
      });

      const filtered = data
        .filter((item) => {
          const name = (item.name || "").toLowerCase();
          const matchName = term ? name.includes(term) : true;
          const matchType = typeVal ? (item.category || "") === typeVal : true;
          return matchName && matchType;
        })
        .slice()
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      // Update informasi jumlah stok saat ini di form berdasarkan nama item yang sedang diinput
      const invNameInput = document.getElementById("invName");
      const invCurrentStock = document.getElementById("invCurrentStock");
      if (invNameInput && invCurrentStock) {
        const nameKey = invNameInput.value.trim().toLowerCase();
        if (!nameKey) {
          invCurrentStock.value = "-";
        } else {
          const total = data.reduce((sum, it) => {
            if (!it.name) return sum;
            if (it.name.trim().toLowerCase() !== nameKey) return sum;
            const s = parseFloat(it.stock || "0") || 0;
            return sum + s;
          }, 0);
          invCurrentStock.value = total > 0 ? String(total) : "0";
        }
      }

      filtered.forEach((item) => {
        const tr = document.createElement("tr");
        tr.className = "bg-white hover:bg-slate-50";

        const isLow = item.minStock && Number(item.stock || 0) <= Number(item.minStock || 0);
        const expiryText = item.expiry ? formatDate(item.expiry) : "-";
        let expiryClass = "";
        if (item.expiry) {
          const today = new Date(todayStr());
          const d = new Date(item.expiry + "T00:00:00");
          const diff = (d - today) / (1000 * 60 * 60 * 24);
          if (diff < 0) expiryClass = "text-red-700";
          else if (diff <= 7) expiryClass = "text-amber-700";
        }

        const numericStock = Number(item.stock || 0);
        const status = [];
        if (numericStock <= 0) {
          status.push("Habis");
        } else {
          if (isLow) status.push("Stok rendah");
          if (item.expiry) {
            const today = new Date(todayStr());
            const d = new Date(item.expiry + "T00:00:00");
            const diff = (d - today) / (1000 * 60 * 60 * 24);
            if (diff < 0) status.push("Expired");
            else if (diff <= 7) status.push("< 7 hari");
          }
        }

        tr.innerHTML = `
            <td class="px-2 py-1.5 align-top">
              <div class="font-medium text-xs">${item.name || "-"}</div>
              <div class="text-[11px] text-slate-600">${item.unit || ""}</div>
            </td>
            <td class="px-2 py-1.5 align-top text-xs">${item.category || "-"}</td>
            <td class="px-2 py-1.5 align-top text-right text-xs">
              <span class="${isLow ? "text-amber-700 font-semibold" : ""}">${item.stock || 0}</span>
            </td>
            <td class="px-2 py-1.5 align-top text-xs ${expiryClass}">${expiryText}</td>
            <td class="px-2 py-1.5 align-top text-xs">${item.productionDate ? formatDate(item.productionDate) : "-"}</td>
            <td class="px-2 py-1.5 align-top text-[11px]">${status.join(", ") || "Normal"}</td>
            <td class="px-2 py-1.5 align-top text-right text-[11px]">
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-inv" data-id="${item.id}">Hapus</button>
            </td>
          `;

        tbody.appendChild(tr);
      });

      if (countLabel) {
        countLabel.textContent = `${filtered.length} item (Habis: ${totalHabis}, Stok rendah: ${totalLow})`;
      }

      tbody.querySelectorAll("[data-action='delete-inv']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.inventory[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus item inventori ini?")) {
            state.inventory[outletId].splice(idx, 1);
            saveState();
            renderInventory();
            refreshStockOutItemOptions();
            updateDashboard();
          }
        });
      });

      renderFefoList();
      refreshStockOutItemOptions();
    }

    function refreshStockOutItemOptions() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const select = document.getElementById("stockOutItem");
      if (!select) return;

      const data = state.inventory[outletId] || [];
      select.innerHTML = "";

      if (!data.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Belum ada item inventori";
        select.appendChild(opt);
        select.disabled = true;
        return;
      }

      select.disabled = false;
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Pilih item...";
      select.appendChild(placeholder);

      // Kelompokkan berdasarkan nama item agar tidak muncul dobel di dropdown
      const uniqueByName = new Map();
      data.forEach((item) => {
        const key = (item.name || "").trim().toLowerCase();
        if (!key) return;
        const existing = uniqueByName.get(key);
        if (!existing) {
          uniqueByName.set(key, item);
        } else {
          // Pilih item yang lebih dulu dipakai: prioritas yang expired lebih cepat, lalu yang tanggal produksinya lebih lama
          const a = existing;
          const b = item;
          const aHasExpiry = !!a.expiry;
          const bHasExpiry = !!b.expiry;
          if (aHasExpiry || bHasExpiry) {
            if (!aHasExpiry && bHasExpiry) {
              uniqueByName.set(key, b);
            } else if (aHasExpiry && bHasExpiry && (b.expiry || "") < (a.expiry || "")) {
              uniqueByName.set(key, b);
            }
          } else {
            const aHasProd = !!a.productionDate;
            const bHasProd = !!b.productionDate;
            if (!aHasProd && bHasProd) {
              uniqueByName.set(key, b);
            } else if (aHasProd && bHasProd && (b.productionDate || "") < (a.productionDate || "")) {
              uniqueByName.set(key, b);
            }
          }
        }
      });

      Array.from(uniqueByName.values())
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        .forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.name || "-";
          select.appendChild(opt);
        });
    }

    function renderFefoList() {
      const outletId = state.selectedOutletId;
      const data = state.inventory[outletId] || [];
      const list = document.getElementById("inventoryFefoList");
      list.innerHTML = "";

      // Hanya ambil item yang punya tanggal expired dan stok > 0
      const withExpiry = data.filter((x) => {
        if (!x.expiry) return false;
        const stock = parseFloat(x.stock || "0") || 0;
        return stock > 0;
      });

      withExpiry.sort((a, b) => (a.expiry || "").localeCompare(b.expiry || ""));

      if (!withExpiry.length) {
        const li = document.createElement("li");
        li.className = "text-slate-600";
        li.textContent = "Belum ada item dengan tanggal expired.";
        list.appendChild(li);
        return;
      }

      withExpiry.slice(0, 15).forEach((item, index) => {
        const li = document.createElement("li");
        const today = new Date(todayStr());
        const d = new Date(item.expiry + "T00:00:00");
        const diff = Math.round((d - today) / (1000 * 60 * 60 * 24));
        let diffText = "";
        let expiryLineClass = "text-slate-600";
        let diffClass = "text-slate-500";

        if (isNaN(diff)) {
          diffText = "";
        } else if (diff < 0) {
          diffText = `(${Math.abs(diff)} hari lewat)`;
          expiryLineClass = "text-red-700";
          diffClass = "text-red-700";
        } else if (diff === 0) {
          diffText = "(hari ini)";
          expiryLineClass = "text-red-700";
          diffClass = "text-red-700";
        } else {
          diffText = `(${diff} hari lagi)`;
          if (diff <= 3) {
            expiryLineClass = "text-red-700";
            diffClass = "text-red-700";
          } else if (diff <= 7) {
            expiryLineClass = "text-amber-700";
            diffClass = "text-amber-700";
          }
        }

        li.className = "flex items-start gap-2 text-[11px]";
        li.innerHTML = `
          <span class="mt-0.5 text-slate-500">${index + 1}.</span>
          <div>
            <div class="font-medium">${item.name || "-"}</div>
            <div class="${expiryLineClass}">Expired: ${formatDate(item.expiry)} <span class="ml-1 ${diffClass}">${diffText}</span></div>
          </div>
        `;
        list.appendChild(li);
      });
    }

    function renderStockOut() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.stockOut[outletId];
      const tbody = document.getElementById("stockOutTableBody");
      const countLabel = document.getElementById("stockOutCountLabel");
      const filterInput = document.getElementById("stockOutFilterDate");
      if (!tbody) return;
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : null;

      const filtered = data
        .filter((item) => (filterDate ? item.date === filterDate : true))
        .slice()
        .sort((a, b) => {
          const dDiff = (b.date || "").localeCompare(a.date || "");
          if (dDiff !== 0) return dDiff;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });

      filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";

          // Bangun detail per tanggal produksi berdasarkan batches (jika ada)
          let productionDetailHtml = "-";
          if (Array.isArray(item.batches) && item.batches.length) {
            const parts = item.batches
              .filter((b) => (b.qty || 0) > 0)
              .map((b) => {
                const d = b.productionDate ? formatDate(b.productionDate) : "-";
                const qtyText = `${b.qty || 0} ${item.unit || ""}`;
                return `${d}: ${qtyText}`;
              });
            if (parts.length) {
              productionDetailHtml = parts.join("<br>");
            }
          } else if (item.productionDate) {
            productionDetailHtml = formatDate(item.productionDate);
          }

          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.itemName || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.qty || 0} ${item.unit || ""}</td>
            <td class="px-2 py-1.5 text-xs">${item.pic || "-"}</td>
            <td class="px-2 py-1.5 text-xs whitespace-pre-line">${productionDetailHtml}</td>
            <td class="px-2 py-1.5 text-right text-[11px]">
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-stockout" data-id="${item.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${data.length} transaksi`;

      tbody.querySelectorAll("[data-action='delete-stockout']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.stockOut[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus catatan stok keluar ini? Stok item akan dikembalikan.")) {
            const record = state.stockOut[outletId][idx];

            if (Array.isArray(record.batches) && record.batches.length) {
              // Kembalikan stok per batch sesuai pemakaian sebelumnya
              record.batches.forEach((b) => {
                const item = state.inventory[outletId].find((x) => x.id === b.itemId);
                if (!item) return;
                const addQty = parseFloat(b.qty || "0") || 0;
                if (addQty <= 0) return;
                const currentStock = parseFloat(item.stock || "0") || 0;
                item.stock = currentStock + addQty;
              });
            } else {
              // Backward compatibility untuk data lama yang belum ada detail batches
              const item = state.inventory[outletId].find((x) => x.id === record.itemId);
              const qty = parseFloat(record.qty || "0") || 0;
              if (item && qty > 0) {
                const currentStock = parseFloat(item.stock || "0") || 0;
                item.stock = currentStock + qty;
              }
            }

            state.stockOut[outletId].splice(idx, 1);
            saveState();
            renderStockOut();
            renderInventory();
            updateDashboard();
          }
        });
      });
    }

    function renderPrep() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.prep[outletId];
      const tbody = document.getElementById("prepTableBody");
      const countLabel = document.getElementById("prepCountLabel");
      const filterInput = document.getElementById("prepFilterDate");
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : null;

      const filtered = data
        .filter((item) => (filterDate ? item.date === filterDate : true))
        .slice()
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";

          const verified = !!item.verified;
          const statusText = verified ? "Terverifikasi" : "Belum";
          const statusClass = verified ? "text-emerald-700 font-semibold" : "text-slate-600";

          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.item || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.qty || 0} ${item.unit || ""}</td>
            <td class="px-2 py-1.5 text-xs">${item.shift || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.pic || "-"}</td>
            <td class="px-2 py-1.5 text-[11px] ${statusClass}">${statusText}</td>
            <td class="px-2 py-1.5 text-[11px] text-slate-600">${item.note || "-"}</td>
            <td class="px-2 py-1.5 text-right text-[11px] space-x-2">
              <button type="button" class="text-emerald-700 hover:text-emerald-600" data-action="toggle-verify-prep" data-id="${item.id}">
                ${verified ? "Batalkan" : "Verifikasi"}
              </button>
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-prep" data-id="${item.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${data.length} batch`;

      tbody.querySelectorAll("[data-action='delete-prep']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.prep[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus data preparation ini?")) {
            state.prep[outletId].splice(idx, 1);
            saveState();
            renderPrep();
            updateDashboard();
          }
        });
      });

      tbody.querySelectorAll("[data-action='toggle-verify-prep']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const rec = state.prep[outletId].find((x) => x.id === id);
          if (!rec) return;
          rec.verified = !rec.verified;
          rec.verifiedAt = rec.verified ? new Date().toISOString() : null;
          saveState();
          renderPrep();
          updateDashboard();
        });
      });
    }

    function renderCleaning() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.cleaning[outletId];
      const tbody = document.getElementById("cleanTableBody");
      const countLabel = document.getElementById("cleanCountLabel");
      const filterInput = document.getElementById("cleanFilterDate");
      const categorySelect = document.getElementById("cleanFilterCategory");
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : todayStr();
      const filterCategory = categorySelect ? categorySelect.value : "";

      const filtered = data
        .filter((item) => {
          const matchDate = item.date === filterDate;
          const matchCategory = filterCategory ? (item.category || "") === filterCategory : true;
          return matchDate && matchCategory;
        })
        .slice()
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      filtered.forEach((item) => {
        const tr = document.createElement("tr");
        tr.className = "bg-white hover:bg-slate-50";

        let statusClass = "";
        if (item.status === "Selesai") statusClass = "text-emerald-700";
        else if (item.status === "Proses") statusClass = "text-amber-700";

        tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.area || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.category || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.result || "-"}</td>
            <td class="px-2 py-1.5 text-[11px] text-slate-600">${item.note || "-"}</td>
            <td class="px-2 py-1.5 text-xs ${statusClass}">${item.status || "-"}</td>
            <td class="px-2 py-1.5 text-right text-[11px] space-x-2">
              <button type="button" class="text-emerald-700 hover:text-emerald-600" data-action="done-clean" data-id="${item.id}">Selesai</button>
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-clean" data-id="${item.id}">Hapus</button>
            </td>
          `;
        tbody.appendChild(tr);
      });

      if (countLabel) countLabel.textContent = `${filtered.length} item`;

      tbody.querySelectorAll("[data-action='delete-clean']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.cleaning[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus checklist ini?")) {
            state.cleaning[outletId].splice(idx, 1);
            saveState();
            renderCleaning();
            updateDashboard();
          }
        });
      });

      tbody.querySelectorAll("[data-action='done-clean']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const item = state.cleaning[outletId].find((x) => x.id === id);
          if (item) {
            item.status = "Selesai";
            saveState();
            renderCleaning();
            updateDashboard();
          }
        });
      });
    }

    function renderSchedule() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.schedules[outletId] || [];
      const calendarEl = document.getElementById("scheduleCalendar");
      const countLabel = document.getElementById("scheduleCountLabel");
      const scheduleMonthInput = document.getElementById("scheduleMonth");
      if (!calendarEl) return;

      calendarEl.innerHTML = "";

      // Hitung periode berdasarkan bulan yang dipilih
      let range = null;
      if (scheduleMonthInput && scheduleMonthInput.value) {
        range = getSchedulePeriodRange(scheduleMonthInput.value);
      }
      if (!range) {
        const info = document.createElement("div");
        info.className = "text-[11px] text-slate-600";
        info.textContent = "Pilih bulan periode di atas untuk melihat jadwal.";
        calendarEl.appendChild(info);
        if (countLabel) countLabel.textContent = "0 shift";
        return;
      }

      const start = range.start;
      const end = range.end;

      // Filter jadwal dalam periode
      const filteredSchedules = data.filter((item) => {
        if (!item.date) return false;
        const d = new Date(item.date + "T00:00:00");
        return !isNaN(d.getTime()) && d >= start && d <= end;
      });

      // Bangun daftar tanggal dalam periode dan map index kolom
      const dates = [];
      const dateIndexMap = new Map();
      let cursor = new Date(start.getTime());
      let col = 0;
      while (cursor <= end) {
        // Buat string tanggal lokal YYYY-MM-DD tanpa toISOString agar tidak bergeser karena zona waktu
        const year = cursor.getFullYear();
        const month = String(cursor.getMonth() + 1).padStart(2, "0");
        const dayNum = String(cursor.getDate()).padStart(2, "0");
        const iso = `${year}-${month}-${dayNum}`;
        dates.push({
          iso,
          day: cursor.getDate(),
          label: cursor.toLocaleDateString("id-ID", { day: "2-digit", month: "short" }),
        });
        dateIndexMap.set(iso, col);
        col++;
        cursor.setDate(cursor.getDate() + 1);
      }

      // Bangun map nama -> jadwal per tanggal
      const nameMap = new Map();
      filteredSchedules.forEach((item) => {
        const nameKey = (item.name || "").trim();
        if (!nameKey) return;
        if (!nameMap.has(nameKey)) {
          nameMap.set(nameKey, {
            name: nameKey,
            // array of per-date entries, index sesuai dates[]
            perDate: Array(dates.length).fill(null),
          });
        }
        const row = nameMap.get(nameKey);
        const idx = dateIndexMap.get(item.date);
        if (idx === undefined) return;

        // Tampilkan hanya shift tanpa posisi di sel kalender
        const cellValue = (item.shift || "").trim();
        if (!row.perDate[idx]) {
          row.perDate[idx] = [];
        }
        row.perDate[idx].push({
          id: item.id,
          text: cellValue || "(shift)",
        });
      });

      const names = Array.from(nameMap.values()).sort((a, b) => a.name.localeCompare(b.name));

      // Jika tidak ada jadwal
      if (!names.length) {
        const info = document.createElement("div");
        info.className = "text-[11px] text-slate-600";
        info.textContent = "Belum ada jadwal pada periode ini.";
        calendarEl.appendChild(info);
        if (countLabel) countLabel.textContent = "0 shift";
        return;
      }

      // Bangun tabel
      const table = document.createElement("table");
      table.className = "min-w-full border-separate border-spacing-y-1";

      const thead = document.createElement("thead");
      thead.className = "text-[10px] sm:text-[11px] uppercase text-slate-600";
      const headRow = document.createElement("tr");

      const nameTh = document.createElement("th");
      nameTh.className = "text-left px-2 py-1.5 sticky left-0 bg-white z-10";
      nameTh.textContent = "Nama";
      headRow.appendChild(nameTh);

      dates.forEach((d) => {
        const th = document.createElement("th");
        const currentDate = new Date(d.iso + "T00:00:00");
        const dayOfWeek = currentDate.getDay(); // 0 = Minggu, 6 = Sabtu
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const isHoliday = isIndonesianHoliday(currentDate);
        const isRedDay = isWeekend || isHoliday;
        th.className = "text-center px-1.5 py-1.5 whitespace-nowrap" + (isRedDay ? " text-red-700" : "");
        th.textContent = d.day;
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      tbody.className = "text-[10px] sm:text-[11px]";

      names.forEach((rowData) => {
        const tr = document.createElement("tr");
        tr.className = "bg-white hover:bg-slate-50";

        const nameTd = document.createElement("td");
        nameTd.className = "px-2 py-1.5 align-top sticky left-0 bg-white z-10 text-xs";
        nameTd.textContent = rowData.name;
        tr.appendChild(nameTd);

        rowData.perDate.forEach((cellEntries, idx) => {
          const td = document.createElement("td");
          td.className = "px-1.5 py-1.5 align-top text-center";

          if (cellEntries && cellEntries.length) {
            const container = document.createElement("div");
            container.className = "space-y-0.5";

            cellEntries.forEach((entry) => {
              const line = document.createElement("div");
              line.className = "inline-flex items-center justify-center gap-1 bg-slate-50 border border-slate-200 rounded px-1.5 py-0.5";

              const textSpan = document.createElement("span");
              const shiftCode = (entry.text || "").trim().toLowerCase();
              let shiftClass = "";
              if (shiftCode === "p") {
                shiftClass = "text-emerald-700 font-semibold";
              } else if (shiftCode === "m") {
                shiftClass = "text-amber-700 font-semibold";
              } else if (shiftCode === "s") {
                shiftClass = "text-sky-700 font-semibold";
              } else if (shiftCode === "off" || shiftCode === "cuti") {
                shiftClass = "text-red-700 font-semibold";
              }
              if (shiftClass) textSpan.className = shiftClass;
              textSpan.textContent = entry.text;
              line.appendChild(textSpan);

              const delBtn = document.createElement("button");
              delBtn.type = "button";
              delBtn.className = "text-[10px] text-rose-700 hover:text-rose-600 ml-1";
              delBtn.textContent = "x";
              delBtn.addEventListener("click", () => {
                const idxSch = state.schedules[outletId].findIndex((x) => x.id === entry.id);
                if (idxSch >= 0 && confirm("Hapus jadwal ini?")) {
                  state.schedules[outletId].splice(idxSch, 1);
                  saveState();
                  renderSchedule();
                  updateDashboard();
                  refreshPrepPicOptions();
                  refreshTasksNameOptions();
                }
              });

              line.appendChild(delBtn);
              container.appendChild(line);
            });

            td.appendChild(container);
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      calendarEl.appendChild(table);

      if (countLabel) countLabel.textContent = `${filteredSchedules.length} shift`;
    }

    function exportScheduleToXls() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.schedules[outletId] || [];
      const scheduleMonthInput = document.getElementById("scheduleMonth");

      if (!scheduleMonthInput || !scheduleMonthInput.value) {
        alert("Pilih bulan periode terlebih dahulu.");
        return;
      }

      const range = getSchedulePeriodRange(scheduleMonthInput.value);
      if (!range) {
        alert("Periode tidak valid.");
        return;
      }

      const start = range.start;
      const end = range.end;

      const filteredSchedules = data.filter((item) => {
        if (!item.date) return false;
        const d = new Date(item.date + "T00:00:00");
        return !isNaN(d.getTime()) && d >= start && d <= end;
      });

      if (!filteredSchedules.length) {
        alert("Tidak ada jadwal pada periode ini untuk diexport.");
        return;
      }

      const dates = [];
      const dateIndexMap = new Map();
      let cursor = new Date(start.getTime());
      let col = 0;
      while (cursor <= end) {
        const year = cursor.getFullYear();
        const month = String(cursor.getMonth() + 1).padStart(2, "0");
        const dayNum = String(cursor.getDate()).padStart(2, "0");
        const iso = `${year}-${month}-${dayNum}`;
        dates.push({ iso, day: cursor.getDate() });
        dateIndexMap.set(iso, col);
        col++;
        cursor.setDate(cursor.getDate() + 1);
      }

      const nameMap = new Map();
      filteredSchedules.forEach((item) => {
        const nameKey = (item.name || "").trim();
        if (!nameKey) return;
        if (!nameMap.has(nameKey)) {
          nameMap.set(nameKey, {
            name: nameKey,
            perDate: Array(dates.length).fill(null),
          });
        }
        const row = nameMap.get(nameKey);
        const idx = dateIndexMap.get(item.date);
        if (idx === undefined) return;
        const cellValue = (item.shift || "").trim();
        if (!row.perDate[idx]) {
          row.perDate[idx] = [];
        }
        row.perDate[idx].push({ text: cellValue || "(shift)" });
      });

      const names = Array.from(nameMap.values()).sort((a, b) => a.name.localeCompare(b.name));
      if (!names.length) {
        alert("Tidak ada jadwal pada periode ini untuk diexport.");
        return;
      }

      const esc = (s) => String(s || "").replace(/[&<>]/g, (c) => (c === "&" ? "&amp;" : c === "<" ? "&lt;" : "&gt;"));

      let html = "<table border='1'><thead><tr><th>Nama</th>";
      dates.forEach((d) => {
        html += `<th>${esc(d.day)}</th>`;
      });
      html += "</tr></thead><tbody>";

      names.forEach((rowData) => {
        html += `<tr><td>${esc(rowData.name)}</td>`;
        rowData.perDate.forEach((cellEntries) => {
          let cellText = "";
          if (cellEntries && cellEntries.length) {
            cellText = cellEntries.map((e) => e.text || "").join(", ");
          }
          html += `<td>${esc(cellText)}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";

      const blob = new Blob(["\ufeff" + html], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const outlet = getCurrentOutlet();
      const outletNamePart = outlet ? outlet.name.replace(/[^a-z0-9]+/gi, "-").toLowerCase() : "outlet";
      a.href = url;
      a.download = `jadwal-${outletNamePart}-${scheduleMonthInput.value}.xls`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function refreshPrepPicOptions() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const prepDateInput = document.getElementById("prepDate");
      const picSelect = document.getElementById("prepPic");
      const shiftSelect = document.getElementById("prepShift");
      if (!prepDateInput || !picSelect) return;

      const date = prepDateInput.value || todayStr();
      const schedules = state.schedules[outletId] || [];

      const perName = new Map();
      schedules.forEach((rec) => {
        if (!rec.date || rec.date !== date) return;
        const name = (rec.name || "").trim();
        if (!name) return;
        if (!perName.has(name)) {
          perName.set(name, (rec.shift || "").trim());
        }
      });

      picSelect.innerHTML = "";

      if (perName.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Belum ada jadwal untuk tanggal ini";
        picSelect.appendChild(opt);
        picSelect.disabled = true;
        return;
      }

      picSelect.disabled = false;
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Pilih karyawan (otomatis dari jadwal)";
      picSelect.appendChild(placeholder);

      Array.from(perName.keys())
        .sort((a, b) => a.localeCompare(b))
        .forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          const shift = perName.get(name) || "";
          if (shift) {
            opt.dataset.shift = shift;
          }
          picSelect.appendChild(opt);
        });
    }

    function refreshTasksNameOptions() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const tasksDateInput = document.getElementById("tasksDate");
      const nameSelect = document.getElementById("tasksName");
      if (!tasksDateInput || !nameSelect) return;

      const date = tasksDateInput.value || todayStr();
      const schedules = state.schedules[outletId] || [];

      const perName = new Map();
      schedules.forEach((rec) => {
        if (!rec.date || rec.date !== date) return;
        const name = (rec.name || "").trim();
        if (!name) return;
        if (!perName.has(name)) {
          perName.set(name, (rec.shift || "").trim());
        }
      });

      nameSelect.innerHTML = "";

      if (perName.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Belum ada jadwal untuk tanggal ini";
        nameSelect.appendChild(opt);
        nameSelect.disabled = true;
        return;
      }

      nameSelect.disabled = false;
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Pilih karyawan dari jadwal";
      nameSelect.appendChild(placeholder);

      Array.from(perName.keys())
        .sort((a, b) => a.localeCompare(b))
        .forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          nameSelect.appendChild(opt);
        });
    }

    function renderTasks() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.tasks[outletId];
      const tbody = document.getElementById("tasksTableBody");
      const countLabel = document.getElementById("tasksCountLabel");
      const filterInput = document.getElementById("tasksFilterDate");
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : null;

      const filtered = data
        .filter((item) => (filterDate ? item.date === filterDate : true))
        .slice()
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""));

      filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";

          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.name || "-"}</td>
            <td class="px-2 py-1.5 text-[11px]">${item.desc || "-"}</td>
            <td class="px-2 py-1.5 text-right text-[11px] space-x-2">
              <button type="button" class="text-emerald-700 hover:text-emerald-600" data-action="done-task" data-id="${item.id}">Selesai</button>
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-task" data-id="${item.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${data.length} tugas`;

      tbody.querySelectorAll("[data-action='delete-task']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.tasks[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus tugas ini?")) {
            state.tasks[outletId].splice(idx, 1);
            saveState();
            renderTasks();
            updateDashboard();
          }
        });
      });

      tbody.querySelectorAll("[data-action='done-task']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const item = state.tasks[outletId].find((x) => x.id === id);
          if (item) {
            item.status = "Selesai";
            saveState();
            renderTasks();
            updateDashboard();
          }
        });
      });
    }

    function renderFeedback() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.feedback[outletId];
      const tbody = document.getElementById("fbTableBody");
      const countLabel = document.getElementById("fbCountLabel");
      tbody.innerHTML = "";

      const filterInput = document.getElementById("fbFilterDate");
      const channelFilter = document.getElementById("fbFilterChannel");
      const filterDate = filterInput && filterInput.value ? filterInput.value : null;
      const filterChannel = channelFilter && channelFilter.value ? channelFilter.value : "";

      const filtered = data
        .filter((item) => {
          const matchDate = filterDate ? item.date === filterDate : true;
          const matchChannel = filterChannel ? (item.channel || "") === filterChannel : true;
          return matchDate && matchChannel;
        })
        .slice()
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";

          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.channel || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.customer || "-"}</td>
            <td class="px-2 py-1.5 text-xs text-emerald-700">${item.rating || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.category || "-"}</td>
            <td class="px-2 py-1.5 text-[11px] text-slate-600">${item.comment || "-"}</td>
            <td class="px-2 py-1.5 text-right text-[11px]">
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-fb" data-id="${item.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${data.length} feedback`;

      tbody.querySelectorAll("[data-action='delete-fb']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const idx = state.feedback[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus feedback ini?")) {
            state.feedback[outletId].splice(idx, 1);
            saveState();
            renderFeedback();
            updateDashboard();
          }
        });
      });

      const ratings = data.map((x) => Number(x.rating)).filter((n) => !isNaN(n));
      const total = ratings.length;
      const avg = total ? ratings.reduce((a, b) => a + b, 0) / total : 0;
      const positive = ratings.filter((r) => r >= 4).length;
      const negative = ratings.filter((r) => r <= 2).length;

      const avgEl = document.getElementById("fbAvgRating");
      const totalEl = document.getElementById("fbTotalRating");
      const posEl = document.getElementById("fbPositiveCount");
      const negEl = document.getElementById("fbNegativeCount");

      if (avgEl) avgEl.textContent = total ? avg.toFixed(2) : "-";
      if (totalEl) totalEl.textContent = String(total);
      if (posEl) posEl.textContent = String(positive);
      if (negEl) negEl.textContent = String(negative);
    }

    function updateFbRatingOptions() {
      const channelSelect = document.getElementById("fbChannel");
      const ratingSelect = document.getElementById("fbRating");
      if (!channelSelect || !ratingSelect) return;
      const channel = channelSelect.value;
      ratingSelect.innerHTML = "";

      if (channel === "Google Review") {
        const options = [
          { value: "5", label: "5 - Sangat puas" },
          { value: "4", label: "4 - Puas" },
          { value: "3", label: "3 - Cukup" },
          { value: "2", label: "2 - Kurang" },
          { value: "1", label: "1 - Tidak puas" },
        ];
        options.forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.label;
          ratingSelect.appendChild(o);
        });
      } else {
        const puasOpt = document.createElement("option");
        puasOpt.value = "5";
        puasOpt.textContent = "Puas";
        ratingSelect.appendChild(puasOpt);

        const tidakOpt = document.createElement("option");
        tidakOpt.value = "1";
        tidakOpt.textContent = "Tidak puas";
        ratingSelect.appendChild(tidakOpt);
      }

      updateFbCategoryOptions();
    }

    function updateFbCategoryOptions() {
      const ratingSelect = document.getElementById("fbRating");
      const categorySelect = document.getElementById("fbCategory");
      if (!ratingSelect || !categorySelect) return;

      const ratingVal = parseInt(ratingSelect.value, 10);
      categorySelect.innerHTML = "";

      if (!ratingVal || isNaN(ratingVal)) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Pilih kategori...";
        categorySelect.appendChild(opt);
        categorySelect.disabled = true;
        return;
      }

      categorySelect.disabled = false;

      let options;
      if (ratingVal >= 3) {
        options = [
          { value: "Pelayanan", label: "Pelayanan" },
          { value: "Produk", label: "Produk" },
          { value: "Fasilitas", label: "Fasilitas" },
        ];
      } else {
        const labels = [
          "Pelayanan Lama",
          "Pelayanan tidak ramah",
          "Produk tidak sesuai selera",
          "Produk tidak sesuai",
          "Produk ada benda asing",
          "Produk tidak layak",
          "Fasilitas tidak lengkap",
          "Fasilitas tidak nyaman",
        ];
        options = labels.map((label) => ({ value: label, label }));
      }

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Pilih kategori...";
      categorySelect.appendChild(placeholder);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        categorySelect.appendChild(o);
      });
    }

    function renderChecklistTemplates() {
      if (!state.cleanTemplates) return;
      const tbody = document.getElementById("checklistTableBody");
      const filterSelect = document.getElementById("checklistFilterCategory");
      if (!tbody || !filterSelect) return;
      const category = filterSelect.value || "Cleaning";
      const items = state.cleanTemplates[category] || [];
      tbody.innerHTML = "";

      items.forEach((name, index) => {
        const tr = document.createElement("tr");
        tr.className = "bg-white hover:bg-slate-50";
        tr.innerHTML = `
          <td class="px-2 py-1.5 text-xs">${
            category === "Cleaning" ? "Cleaning Area" : category === "Grooming" ? "Grooming Karyawan" : "Equipment"
          }</td>
          <td class="px-2 py-1.5 text-xs">${name}</td>
          <td class="px-2 py-1.5 text-right text-[11px] space-x-2">
            <button type="button" class="text-sky-700 hover:text-sky-600" data-action="edit-checklist" data-category="${category}" data-index="${index}">Edit</button>
            <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-checklist" data-category="${category}" data-index="${index}">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("[data-action='edit-checklist']").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (state.role === 'karyawan') {
            alert("Hanya Kepala Cabang dan Admin yang boleh mengelola template checklist. Silakan masuk sebagai Kepala Cabang atau Admin.");
            return;
          }
          const cat = btn.getAttribute("data-category");
          const idx = parseInt(btn.getAttribute("data-index"), 10);
          const list = state.cleanTemplates[cat] || [];
          if (!list[idx]) return;
          const current = list[idx];
          const updated = prompt("Nama item checklist baru:", current);
          if (updated === null) return;
          const trimmed = updated.trim();
          if (!trimmed) {
            alert("Nama item tidak boleh kosong.");
            return;
          }
          list[idx] = trimmed;
          saveState();
          renderChecklistTemplates();
        });
      });

      tbody.querySelectorAll("[data-action='delete-checklist']").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (state.role === 'karyawan') {
            alert("Hanya Kepala Cabang dan Admin yang boleh mengelola template checklist. Silakan masuk sebagai Kepala Cabang atau Admin.");
            return;
          }
          const cat = btn.getAttribute("data-category");
          const idx = parseInt(btn.getAttribute("data-index"), 10);
          const list = state.cleanTemplates[cat] || [];
          if (!list[idx]) return;
          if (!confirm("Hapus item checklist ini dari template?")) return;
          list.splice(idx, 1);
          saveState();
          renderChecklistTemplates();
        });
      });
    }

    function renderOutlets() {
      const tbody = document.getElementById("outletTableBody");
      const countLabel = document.getElementById("outletCountLabel");
      tbody.innerHTML = "";

      state.outlets
        .slice()
        .sort((a, b) => (a.id || "").localeCompare(b.id || ""))
        .forEach((o) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";
          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs text-slate-600">${o.id}</td>
            <td class="px-2 py-1.5 text-xs">${o.name}</td>
            <td class="px-2 py-1.5 text-xs">${o.location || "-"}</td>
            <td class="px-2 py-1.5 text-right text-[11px] space-x-2">
              <button type="button" class="text-sky-700 hover:text-sky-600" data-action="edit-outlet" data-id="${o.id}">Edit</button>
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-outlet" data-id="${o.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${state.outlets.length}`;

      tbody.querySelectorAll("[data-action='edit-outlet']").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (state.role !== 'admin') {
            alert("Hanya Admin yang boleh mengelola outlet. Silakan masuk sebagai admin.");
            return;
          }
          const id = btn.getAttribute("data-id");
          const outlet = state.outlets.find((o) => o.id === id);
          if (!outlet) return;
          const newName = prompt("Nama outlet baru:", outlet.name || "");
          if (newName === null) return;
          const newLoc = prompt("Lokasi / kota baru:", outlet.location || "");
          outlet.name = newName.trim() || outlet.name;
          outlet.location = (newLoc || "").trim();
          saveState();
          renderOutlets();
          renderOutletDropdown();
          refreshOutletLabels();
          updateDashboard();
        });
      });

      tbody.querySelectorAll("[data-action='delete-outlet']").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (state.role !== 'admin') {
            alert("Hanya Admin yang boleh mengelola outlet. Silakan masuk sebagai admin.");
            return;
          }
          const id = btn.getAttribute("data-id");
          if (!confirm("Hapus outlet ini? Semua data terkait outlet ini di perangkat ini juga akan dihapus.")) return;
          const idx = state.outlets.findIndex((o) => o.id === id);
          if (idx < 0) return;
          state.outlets.splice(idx, 1);
          delete state.inventory[id];
          delete state.stockOut[id];
          delete state.prep[id];
          delete state.cleaning[id];
          delete state.schedules[id];
          delete state.tasks[id];
          delete state.feedback[id];
          delete state.quickNotes[id];
          if (state.selectedOutletId === id) {
            state.selectedOutletId = state.outlets[0] ? state.outlets[0].id : null;
          }
          saveState();
          renderOutlets();
          renderOutletDropdown();
          refreshOutletLabels();
          renderAllForCurrentOutlet();
        });
      });
    }

    function renderQuickNotes() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const txt = state.quickNotes[outletId] || "";
      const el = document.getElementById("quickNotes");
      if (el) el.value = txt;
    }

    function renderRejects() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.rejects[outletId] || [];
      const tbody = document.getElementById("rejectTableBody");
      const countLabel = document.getElementById("rejectCountLabel");
      const filterInput = document.getElementById("rejectFilterDate");
      if (!tbody) return;
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : null;

      const filtered = data
        .slice()
        .filter((item) => (filterDate ? item.date === filterDate : true))
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      filtered.forEach((item) => {
        const tr = document.createElement("tr");
        tr.className = "bg-white hover:bg-slate-50";
        tr.innerHTML = `
          <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
          <td class="px-2 py-1.5 text-xs">${item.itemName || "-"}</td>
          <td class="px-2 py-1.5 text-xs">${item.qty || 0} ${item.unit || ""}</td>
          <td class="px-2 py-1.5 text-xs">${item.reason || "-"}</td>
          <td class="px-2 py-1.5 text-xs">${item.pic || "-"}</td>
          <td class="px-2 py-1.5 text-[11px] text-slate-600">${item.note || "-"}</td>
          <td class="px-2 py-1.5 text-right text-[11px]">
            <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-reject" data-id="${item.id}">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (countLabel) countLabel.textContent = `${data.length} catatan`;

      tbody.querySelectorAll("[data-action='delete-reject']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const outletId = state.selectedOutletId;
          ensureOutletContainers(outletId);
          const id = btn.getAttribute("data-id");
          const idx = state.rejects[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus catatan reject ini? Stok item akan dikembalikan.")) {
            const record = state.rejects[outletId][idx];
            const invItem = state.inventory[outletId].find((x) => x.id === record.itemId);
            const qty = parseFloat(record.qty || "0") || 0;
            if (invItem && qty > 0) {
              const currentStock = parseFloat(invItem.stock || "0") || 0;
              invItem.stock = currentStock + qty;
            }
            state.rejects[outletId].splice(idx, 1);
            saveState();
            renderRejects();
            renderInventory();
            updateDashboard();
          }
        });
      });
    }

    function renderLogbook() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const data = state.logbook[outletId] || [];
      const tbody = document.getElementById("logTableBody");
      const countLabel = document.getElementById("logCountLabel");
      const filterInput = document.getElementById("logFilterDate");
      if (!tbody) return;
      tbody.innerHTML = "";

      const filterDate = filterInput && filterInput.value ? filterInput.value : null;

      const filtered = data
        .slice()
        .filter((item) => (filterDate ? item.date === filterDate : true))
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      filtered.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white hover:bg-slate-50";

          tr.innerHTML = `
            <td class="px-2 py-1.5 text-xs">${formatDate(item.date)}</td>
            <td class="px-2 py-1.5 text-xs">${item.shift || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.author || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.title || "-"}</td>
            <td class="px-2 py-1.5 text-[11px] text-slate-600">${item.content || "-"}</td>
            <td class="px-2 py-1.5 text-xs">${item.forNextShift ? "Ya" : "Tidak"}</td>
            <td class="px-2 py-1.5 text-right text-[11px]">
              <button type="button" class="text-rose-700 hover:text-rose-600" data-action="delete-log" data-id="${item.id}">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (countLabel) countLabel.textContent = `${data.length} catatan`;

      tbody.querySelectorAll("[data-action='delete-log']").forEach((btn) => {
        btn.addEventListener("click", () => {
          const outletId = state.selectedOutletId;
          ensureOutletContainers(outletId);
          const id = btn.getAttribute("data-id");
          const idx = state.logbook[outletId].findIndex((x) => x.id === id);
          if (idx >= 0 && confirm("Hapus catatan log book ini?")) {
            state.logbook[outletId].splice(idx, 1);
            saveState();
            renderLogbook();
          }
        });
      });
    }

    function renderDashboard() {
      const outletId = state.selectedOutletId;
      ensureOutletContainers(outletId);
      const inv = state.inventory[outletId];
      const tasks = state.tasks[outletId];
      const prep = state.prep[outletId];
      const cleaning = state.cleaning[outletId];
      const fb = state.feedback[outletId];
      const today = todayStr();

      const lowStock = inv.filter((x) => Number(x.minStock || 0) > 0 && Number(x.stock || 0) <= Number(x.minStock || 0)).length;

      const upcomingExpiry = inv.filter((x) => {
        if (!x.expiry) return false;
        const todayDate = new Date(today + "T00:00:00");
        const d = new Date(x.expiry + "T00:00:00");
        const diff = (d - todayDate) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 7;
      }).length;

      const pendingTasks = tasks.filter((x) => x.date === today && x.status !== "Selesai").length;

      const todayPrep = prep.filter((x) => x.date === today).length;
      const todayCleaning = cleaning.filter((x) => x.date === today).length;
      const todayCleaningDone = cleaning.filter((x) => x.date === today && x.status === "Selesai").length;
      const todayFb = fb.filter((x) => x.date === today).length;

      const ratings = fb.map((x) => Number(x.rating)).filter((n) => !isNaN(n));
      const totalRatings = ratings.length;
      const avgRating = totalRatings ? ratings.reduce((a, b) => a + b, 0) / totalRatings : 0;

      const lowEl = document.getElementById("dashLowStock");
      const expEl = document.getElementById("dashUpcomingExpiry");
      const taskEl = document.getElementById("dashPendingTasks");
      const avgEl = document.getElementById("dashAvgRating");
      const prepEl = document.getElementById("dashPrepCount");
      const cleanEl = document.getElementById("dashCleaningDone");
      const fbTodayEl = document.getElementById("dashFeedbackToday");
      const todayLabel = document.getElementById("dashTodayLabel");

      if (lowEl) lowEl.textContent = String(lowStock);
      if (expEl) expEl.textContent = String(upcomingExpiry);
      if (taskEl) taskEl.textContent = String(pendingTasks);
      if (avgEl) avgEl.textContent = totalRatings ? avgRating.toFixed(2) : "-";
      if (prepEl) prepEl.textContent = String(todayPrep);
      if (cleanEl) cleanEl.textContent = `${todayCleaningDone} / ${todayCleaning}`;
      if (fbTodayEl) fbTodayEl.textContent = String(todayFb);
      if (todayLabel) todayLabel.textContent = new Date().toLocaleDateString("id-ID", { weekday: "long", day: "2-digit", month: "short", year: "numeric" });
    }

    function renderAdminDashboardGlobal() {
      const adminDashEl = document.getElementById('adminGlobalDashboard');
      if (!adminDashEl || state.role !== 'admin') return;

      const today = todayStr();
      const dateLabel = document.getElementById('adminDashDateLabel');
      if (dateLabel) {
        dateLabel.textContent = new Date().toLocaleDateString("id-ID", { weekday: "long", day: "2-digit", month: "short", year: "numeric" });
      }

      let totalOutlets = state.outlets.length;
      let checklistTotal = 0;
      let checklistDone = 0;
      let checklistNotOk = 0;
      let prepToday = 0;
      let tasksToday = 0;
      let tasksPending = 0;
      let rejectCount = 0;
      let rejectQtyTotal = 0;
      let feedbackToday = 0;
      let feedbackNegativeToday = 0;

      const perOutlet = [];

      state.outlets.forEach((o) => {
        const id = o.id;
        ensureOutletContainers(id);

        const cleanList = (state.cleaning[id] || []).filter((r) => r.date === today);
        const prepList = (state.prep[id] || []).filter((r) => r.date === today);
        const taskList = (state.tasks[id] || []).filter((r) => r.date === today);
        const rejectList = (state.rejects[id] || []).filter((r) => r.date === today);
        const fbList = (state.feedback[id] || []).filter((r) => r.date === today);

        const cleanTotal = cleanList.length;
        const cleanDone = cleanList.filter((r) => r.status === 'Selesai').length;
        const cleanNotOk = cleanList.filter((r) => (r.result || '').toLowerCase() !== 'ok').length;

        const prepCount = prepList.length;
        const tasksCount = taskList.length;
        const tasksPend = taskList.filter((r) => r.status !== 'Selesai').length;

        const rejCount = rejectList.length;
        let rejQty = 0;
        rejectList.forEach((r) => {
          const qn = Number(r.qty);
          if (!isNaN(qn)) rejQty += qn;
        });

        const fbCount = fbList.length;
        const fbNeg = fbList.filter((r) => Number(r.rating) <= 2).length;

        checklistTotal += cleanTotal;
        checklistDone += cleanDone;
        checklistNotOk += cleanNotOk;
        prepToday += prepCount;
        tasksToday += tasksCount;
        tasksPending += tasksPend;
        rejectCount += rejCount;
        rejectQtyTotal += rejQty;
        feedbackToday += fbCount;
        feedbackNegativeToday += fbNeg;

        perOutlet.push({
          outletId: id,
          name: o.name,
          cleanTotal,
          cleanDone,
          cleanNotOk,
          prepCount,
          tasksPend,
          rejQty,
          fbNeg,
        });
      });

      const totalOutletsEl = document.getElementById('adminDashTotalOutlets');
      const checklistEl = document.getElementById('adminDashChecklist');
      const prepEl = document.getElementById('adminDashPrep');
      const tasksEl = document.getElementById('adminDashTasks');
      const rejectEl = document.getElementById('adminDashReject');
      const fbNegEl = document.getElementById('adminDashFbNeg');

      if (totalOutletsEl) totalOutletsEl.textContent = String(totalOutlets);
      if (checklistEl) checklistEl.textContent = `${checklistDone} / ${checklistTotal}`;
      if (prepEl) prepEl.textContent = String(prepToday);
      if (tasksEl) tasksEl.textContent = `${tasksToday} (${tasksPending} pending)`;
      if (rejectEl) rejectEl.textContent = String(rejectQtyTotal);
      if (fbNegEl) fbNegEl.textContent = String(feedbackNegativeToday);

      const body = document.getElementById('adminOutletSummaryBody');
      const label = document.getElementById('adminOutletSummaryLabel');
      if (body) {
        body.innerHTML = '';
        perOutlet.forEach((row) => {
          if (!row.cleanTotal && !row.prepCount && !row.tasksPend && !row.rejQty && !row.fbNeg) return;
          const tr = document.createElement('tr');
          tr.className = 'bg-white hover:bg-slate-50';
          tr.innerHTML = `
            <td class="px-2 py-1.5 align-top text-xs">${row.name}</td>
            <td class="px-2 py-1.5 align-top text-xs">${row.cleanDone} / ${row.cleanTotal}</td>
            <td class="px-2 py-1.5 align-top text-xs">${row.prepCount}</td>
            <td class="px-2 py-1.5 align-top text-xs">${row.tasksPend}</td>
            <td class="px-2 py-1.5 align-top text-xs">${row.rejQty}</td>
            <td class="px-2 py-1.5 align-top text-xs">${row.fbNeg}</td>
          `;
          body.appendChild(tr);
        });
      }
      if (label) {
        label.textContent = `${perOutlet.length} outlet`;
      }
    }

    function renderAllForCurrentOutlet() {
      refreshOutletLabels();
      renderInventory();
      renderStockOut();
      renderPrep();
      renderCleaning();
      renderSchedule();
      renderTasks();
      renderFeedback();
      renderRejects();
      renderLogbook();
      renderDashboard();
      renderChecklistTemplates();
      if (state.role === 'admin') {
        renderAdminDashboardGlobal();
      }
    }

    function setupEventListeners() {
      const sidebar = document.getElementById("sidebar");
      const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
      const scheduleExportXlsBtn = document.getElementById("scheduleExportXlsBtn");

      if (scheduleExportXlsBtn) {
        scheduleExportXlsBtn.addEventListener("click", () => {
          exportScheduleToXls();
        });
      }

      if (sidebarToggleBtn && sidebar) {
        sidebarToggleBtn.addEventListener("click", () => {
          const isOpen = sidebar.classList.toggle("sidebar-mobile-open");
          if (isOpen) {
            sidebar.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
          } else {
            sidebar.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
          }
        });
      }

      document.querySelectorAll(".section-tab").forEach((btn) => {
        const target = btn.getAttribute("data-section");
        if (!target) return;
        btn.addEventListener("click", () => {
          switchSection(target);
          if (window.innerWidth < 768 && sidebar) {
            sidebar.classList.remove("sidebar-mobile-open");
            sidebar.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
          }
        });
      });

      const outletSelect = document.getElementById("outletSelect");
      outletSelect.addEventListener("change", (e) => {
        const newId = e.target.value;
        // Jika role Area Manager, pastikan outlet baru termasuk wilayahnya
        if (state.role === 'area' && state.areaRegion && AREA_MANAGER_REGIONS[state.areaRegion]) {
          const allowed = new Set(AREA_MANAGER_REGIONS[state.areaRegion].outlets || []);
          if (!allowed.has(newId)) {
            alert("Outlet ini di luar wilayah Area Manager yang sedang login.");
            // Kembalikan pilihan ke outlet sebelumnya
            renderOutletDropdown();
            return;
          }
        }
        state.selectedOutletId = newId;
        ensureOutletContainers(state.selectedOutletId);
        saveState();
        renderAllForCurrentOutlet();
        refreshPrepPicOptions();
        refreshTasksNameOptions();
      });

      const invSearch = document.getElementById("invSearch");
      if (invSearch) {
        invSearch.addEventListener("input", () => {
          renderInventory();
        });
      }
      const invTypeFilter = document.getElementById("invTypeFilter");
      if (invTypeFilter) {
        invTypeFilter.addEventListener("change", () => {
          renderInventory();
        });
      }

      const headLoginBtn = document.getElementById("headLoginBtn");
      const areaLoginBtn = document.getElementById("areaLoginBtn");
      const adminLoginBtn = document.getElementById("adminLoginBtn");

      if (headLoginBtn) {
        headLoginBtn.addEventListener("click", () => {
          const pwd = prompt("Masukkan password Kepala Cabang:");
          if (pwd === null) return;
          const outletId = state.selectedOutletId;
          const expected = (HEAD_PASSWORDS && HEAD_PASSWORDS[outletId]) || (HEAD_PASSWORDS && HEAD_PASSWORDS.default) || ADMIN_PASSWORD;
          if (pwd === expected) {
            state.role = 'kepala';
            state.areaRegion = null;
            saveState();
            updateAdminUI();
            alert("Login Kepala Cabang berhasil.");
          } else {
            alert("Password salah.");
          }
        });
      }

      if (areaLoginBtn) {
        areaLoginBtn.addEventListener("click", () => {
          const outletId = state.selectedOutletId;
          if (!outletId) {
            alert("Pilih outlet terlebih dahulu.");
            return;
          }
          // Cari wilayah yang mencakup outlet ini
          let regionKey = null;
          let regionConfig = null;
          for (const [key, cfg] of Object.entries(AREA_MANAGER_REGIONS)) {
            if (cfg && Array.isArray(cfg.outlets) && cfg.outlets.includes(outletId)) {
              regionKey = key;
              regionConfig = cfg;
              break;
            }
          }
          if (!regionConfig) {
            alert("Outlet ini belum di-assign ke Area Manager.");
            return;
          }
          const pwd = prompt(`Masukkan password Area Manager untuk wilayah ${regionKey.toUpperCase()}:`);
          if (pwd === null) return;
          if (pwd === regionConfig.password) {
            state.role = 'area';
            state.areaRegion = regionKey;
            saveState();
            updateAdminUI();
            alert("Login Area Manager berhasil.");
          } else {
            alert("Password salah.");
          }
        });
      }

      adminLoginBtn.addEventListener("click", () => {
        const pwd = prompt("Masukkan password admin:");
        if (pwd === null) return;
        if (pwd === ADMIN_PASSWORD) {
          state.role = 'admin';
          saveState();
          updateAdminUI();
          alert("Login admin berhasil.");
        } else {
          alert("Password salah.");
        }
      });

      const logoutBtn = document.getElementById("adminLogoutBtn");
      logoutBtn.addEventListener("click", () => {
        state.role = 'karyawan';
        state.isAdmin = false;
        state.areaRegion = null;
        saveState();
        updateAdminUI();
      });

      const invForm = document.getElementById("inventoryForm");
      const invNameInput = document.getElementById("invName");
      const invCurrentStockInput = document.getElementById("invCurrentStock");
      const invUnitSelect = document.getElementById("invUnit");
      const invCategorySelect = document.getElementById("invCategory");

      // Perbarui informasi jumlah stok saat ini ketika nama item diubah,
      // dan isi otomatis Jenis & Satuan berdasarkan template default.
      if (invNameInput && invCurrentStockInput) {
        invNameInput.addEventListener("input", () => {
          const name = invNameInput.value.trim();

          // Mapping default Jenis & Satuan per Nama Item
          const ITEM_META = {
            "Ayam Negeri": { category: "BBF", unit: "Kg" },
            "Ayam Buncis": { category: "P00", unit: "Kg" },
            "Ayam Kuning": { category: "P00", unit: "Pcs" },
            "Ayam Kuning Negeri": { category: "P00", unit: "Pcs" },
            "Ayam Marinade": { category: "P00", unit: "Kg" },
            "BAWANG GORENG": { category: "P00", unit: "Kg" },
            "BIANG BUMBU OTAK-OTAK": { category: "P00", unit: "Kg" },
            "BIANG BUMBU SIOMAY": { category: "P00", unit: "Kg" },
            "BIANG SAMBAL": { category: "P00", unit: "Kg" },
            "BIANG SAYUR ASEM": { category: "P00", unit: "Kg" },
            "BIANG SOTO AYAM": { category: "P00", unit: "Kg" },
            "BONELESS MARINADE": { category: "P00", unit: "Kg" },
            "BONELESS TIM": { category: "P00", unit: "Kg" },
            "BUMBU ASINAN": { category: "P00", unit: "Prs" },
            "BUMBU KALDU RASA": { category: "P00", unit: "Pcs" },
            "BUMBU MIE AYAM": { category: "P00", unit: "Kg" },
            "BUMBU MIE JAWA": { category: "P00", unit: "Kg" },
            "BUMBU NASI GORENG": { category: "P00", unit: "Kg" },
            "BUMBU TAHU": { category: "P00", unit: "Prs" },
            "BUNTUT NASI GORENG": { category: "P00", unit: "Prs" },
            "BUNTUT SOP": { category: "P00", unit: "Prs" },
            "DURIAN": { category: "P00", unit: "Prs" },
            "EBI MATANG": { category: "P00", unit: "Kg" },
            "EMPAL": { category: "P00", unit: "Pcs" },
            "SIOMAY": { category: "P00", unit: "Pcs" },
            "SIOMAY KEMBANG TAHU": { category: "P00", unit: "Pcs" },
            "SIOMAY UDANG": { category: "P00", unit: "Pcs" },
            "SOTO BETAWI": { category: "P00", unit: "Prs" },
            "GULA REMPAH": { category: "P00", unit: "Prs" },
            "IGA SOP": { category: "P00", unit: "Prs" },
            "KACANG GORENG": { category: "P00", unit: "Kg" },
            "KECAP MIE AYAM": { category: "P00", unit: "Kg" },
            "KECAP OPLOS ( B )": { category: "P00", unit: "Kg" },
            "KECAP OPLOS": { category: "P00", unit: "Kg" },
            "KELAPA KOPYOR": { category: "P00", unit: "Prs" },
            "KERONGKONG AYAM": { category: "P00", unit: "Kg" },
            "KUAH CAH": { category: "P00", unit: "Kg" },
            "KUAH CAP CAY": { category: "P00", unit: "Prs" },
            "KUAH PEMPEK": { category: "P00", unit: "Kg" },
            "MINYAK MIE AYAM": { category: "P00", unit: "Kg" },
            "OTAK-OTAK BAKAR": { category: "P00", unit: "Pcs" },
            "PEMPEK KAPAL SELAM": { category: "P00", unit: "Pcs" },
            "PEMPEK KEJU": { category: "P00", unit: "Pcs" },
            "PEMPEK LENJERAN": { category: "P00", unit: "Pcs" },
            "PLETOK SET @1 SET": { category: "P00", unit: "Prs" },
            "RISOLES": { category: "P00", unit: "Pcs" },
            "SAMBAL HIJAU": { category: "P00", unit: "Kg" },
            "SAOS KUNGPAO": { category: "P00", unit: "Kg" },
            "SAOS TELOR ASIN": { category: "P00", unit: "Kg" },
            "SAPI MARINADE": { category: "P00", unit: "Kg" },
            "SIRSAK": { category: "P00", unit: "Prs" },
            "STROBERI": { category: "P00", unit: "Prs" },
            "TEPUNG PREMIX": { category: "P00", unit: "Kg" },
            "TERASI MATANG": { category: "P00", unit: "Grm" },
            "TONGSENG AYAM": { category: "P00", unit: "Prs" },
            "TONGSENG SOP": { category: "P00", unit: "Prs" },
          };

          const meta = ITEM_META[name];
          if (meta) {
            if (invCategorySelect) invCategorySelect.value = meta.category;
            if (invUnitSelect) invUnitSelect.value = meta.unit;
          }

          renderInventory();
        });
      }

      invForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const name = document.getElementById("invName").value.trim();
        const category = document.getElementById("invCategory").value.trim();
        const stockRaw = parseFloat(document.getElementById("invStock").value || "0");
        const unit = document.getElementById("invUnit").value.trim();
        const expiry = document.getElementById("invExpiry").value;
        const productionDate = document.getElementById("invProduction").value;
        const minStockRaw = parseFloat(document.getElementById("invMinStock").value || "0");

        if (!name) {
          alert("Nama item wajib diisi.");
          return;
        }

        const stock = isNaN(stockRaw) ? 0 : stockRaw;
        const minStock = isNaN(minStockRaw) ? 0 : minStockRaw;
        const nameKey = name.toLowerCase();
        const items = state.inventory[outletId];

        // Cari apakah sudah ada item dengan nama, tanggal produksi, jenis, dan satuan yang sama
        const existing = items.find((item) => {
          const itemNameKey = (item.name || "").trim().toLowerCase();
          return (
            itemNameKey === nameKey &&
            (item.productionDate || "") === (productionDate || "") &&
            (item.unit || "") === unit &&
            (item.category || "") === category
          );
        });

        if (existing) {
          const prevStock = parseFloat(existing.stock || "0") || 0;
          existing.stock = prevStock + stock;

          // Gabungkan informasi expired: pilih yang lebih awal jika keduanya ada
          if (expiry) {
            if (!existing.expiry) {
              existing.expiry = expiry;
            } else if (existing.expiry !== expiry) {
              existing.expiry = existing.expiry < expiry ? existing.expiry : expiry;
            }
          }

          // Jika user mengisi minimum stok baru (> 0), perbarui juga
          if (minStock > 0) {
            existing.minStock = minStock;
          }

          saveState();
          invForm.reset();

          const prodLabel = productionDate ? formatDate(productionDate) : "-";
          alert(
            `Stok ${name} (tgl produksi ${prodLabel}) diperbarui dari ${prevStock} menjadi ${existing.stock}.`
          );
        } else {
          // Item baru
          items.push({
            id: "INV-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
            name,
            category,
            stock,
            unit,
            expiry: expiry || null,
            productionDate: productionDate || null,
            minStock,
          });

          saveState();
          invForm.reset();
          alert(`Item ${name} ditambahkan dengan stok ${stock}.`);
        }

        renderInventory();
        updateDashboard();
        refreshStockOutItemOptions();
      });

      const stockOutForm = document.getElementById("stockOutForm");
      const stockOutItemSelect = document.getElementById("stockOutItem");
      const stockOutProductionInput = document.getElementById("stockOutProduction");

      // Saat memilih item, isi otomatis tanggal produksi paling lama (batch tertua) untuk nama item tersebut
      if (stockOutItemSelect && stockOutProductionInput) {
        stockOutItemSelect.addEventListener("change", () => {
          const outletId = state.selectedOutletId;
          ensureOutletContainers(outletId);
          const itemId = stockOutItemSelect.value;

          if (!itemId) {
            stockOutProductionInput.value = "";
            return;
          }

          const allItems = state.inventory[outletId] || [];
          const baseItem = allItems.find((x) => x.id === itemId);
          if (!baseItem || !baseItem.name) {
            stockOutProductionInput.value = "";
            return;
          }

          const nameKey = baseItem.name.trim().toLowerCase();
          let earliestProd = null;

          // Cari tanggal produksi tertua dari batch dengan nama yang sama dan stok > 0
          allItems.forEach((it) => {
            if (!it.name || !it.productionDate) return;
            const stockVal = parseFloat(it.stock || "0") || 0;
            if (stockVal <= 0) return;
            if (it.name.trim().toLowerCase() !== nameKey) return;
            if (!earliestProd || it.productionDate < earliestProd) {
              earliestProd = it.productionDate;
            }
          });

          if (earliestProd) {
            stockOutProductionInput.value = formatDate(earliestProd);
          } else {
            stockOutProductionInput.value = "";
          }
        });
      }

      stockOutForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const selectedItemId = document.getElementById("stockOutItem").value;
        const date = document.getElementById("stockOutDate").value || todayStr();
        const qtyInput = document.getElementById("stockOutQty").value;
        const qty = parseFloat(qtyInput || "0");
        const pic = document.getElementById("stockOutPic").value.trim();

        if (!selectedItemId) {
          alert("Pilih item terlebih dahulu.");
          return;
        }
        if (!qty || qty <= 0) {
          alert("Qty keluar harus lebih besar dari 0.");
          return;
        }

        const allItems = state.inventory[outletId] || [];
        const baseItem = allItems.find((x) => x.id === selectedItemId);
        if (!baseItem) {
          alert("Item tidak ditemukan di inventori.");
          return;
        }

        const nameKey = (baseItem.name || "").trim().toLowerCase();

        // Ambil semua batch dengan nama item yang sama dan stok > 0
        const sameNameBatches = allItems
          .filter((x) => (x.name || "").trim().toLowerCase() === nameKey && parseFloat(x.stock || "0") > 0)
          .slice();

        if (!sameNameBatches.length) {
          alert("Tidak ada stok untuk item ini.");
          return;
        }

        // Urutkan batch FEFO: expired paling cepat, lalu tanggal produksi paling lama (lebih dulu diproduksi)
        sameNameBatches.sort((a, b) => {
          const aExp = a.expiry || "";
          const bExp = b.expiry || "";
          if (aExp && bExp && aExp !== bExp) {
            return aExp.localeCompare(bExp);
          }
          if (!aExp && bExp) return 1;
          if (aExp && !bExp) return -1;

          const aProd = a.productionDate || "";
          const bProd = b.productionDate || "";
          if (aProd && bProd && aProd !== bProd) {
            return aProd.localeCompare(bProd);
          }
          if (!aProd && bProd) return 1;
          if (aProd && !bProd) return -1;
          return 0;
        });

        const totalStock = sameNameBatches.reduce((sum, it) => {
          const s = parseFloat(it.stock || "0") || 0;
          return sum + s;
        }, 0);

        if (totalStock <= 0) {
          alert("Stok item ini sudah habis.");
          return;
        }

        let requestedQty = qty;
        if (qty > totalStock) {
          const proceed = confirm(
            `Qty keluar (${qty}) lebih besar dari total stok tersedia (${totalStock}). Lanjutkan dan habiskan semua stok?`
          );
          if (!proceed) return;
          requestedQty = totalStock;
        }

        let remaining = requestedQty;
        const batchesUsed = [];

        sameNameBatches.forEach((batch) => {
          if (remaining <= 0) return;
          const currentStock = parseFloat(batch.stock || "0") || 0;
          if (currentStock <= 0) return;
          const use = Math.min(currentStock, remaining);
          batch.stock = currentStock - use;
          remaining -= use;
          batchesUsed.push({
            itemId: batch.id,
            qty: use,
            productionDate: batch.productionDate || null,
            expiry: batch.expiry || null,
          });
        });

        const actualQty = requestedQty - remaining;
        if (actualQty <= 0) {
          alert("Tidak ada stok yang bisa dikurangi.");
          return;
        }

        // Cari tanggal produksi paling awal dari batch yang terpakai (untuk tampilan ringkas)
        let earliestProd = null;
        batchesUsed.forEach((b) => {
          if (b.productionDate && (earliestProd === null || b.productionDate < earliestProd)) {
            earliestProd = b.productionDate;
          }
        });

        const baseUnit = baseItem.unit || "";

        state.stockOut[outletId].push({
          id: "STO-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
          createdAt: Date.now(),
          date,
          itemId: batchesUsed.length === 1 ? batchesUsed[0].itemId : baseItem.id,
          itemName: baseItem.name || "",
          qty: actualQty,
          unit: baseUnit,
          pic,
          productionDate: earliestProd,
          batches: batchesUsed,
        });

        saveState();
        stockOutForm.reset();
        const stockOutDateInput = document.getElementById("stockOutDate");
        if (stockOutDateInput) stockOutDateInput.value = date;
        if (stockOutProductionInput) stockOutProductionInput.value = "";
        renderInventory();
        renderStockOut();
        updateDashboard();
      });

      const prepForm = document.getElementById("prepForm");
      const prepDateInput = document.getElementById("prepDate");
      const prepPicSelect = document.getElementById("prepPic");
      const prepShiftSelect = document.getElementById("prepShift");
      const tasksDateInput = document.getElementById("tasksDate");
      const tasksNameSelect = document.getElementById("tasksName");

      if (prepDateInput) {
        prepDateInput.addEventListener("change", () => {
          refreshPrepPicOptions();
        });
      }

      if (tasksDateInput) {
        tasksDateInput.addEventListener("change", () => {
          refreshTasksNameOptions();
        });
      }

      if (prepPicSelect && prepShiftSelect) {
        prepPicSelect.addEventListener("change", () => {
          const selectedOption = prepPicSelect.options[prepPicSelect.selectedIndex];
          if (!selectedOption) return;
          const shift = selectedOption.dataset.shift || "";
          if (shift) {
            prepShiftSelect.value = shift;
          }
        });
      }

      prepForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const date = document.getElementById("prepDate").value || todayStr();
        const item = document.getElementById("prepItem").value.trim();
        const qty = parseFloat(document.getElementById("prepQty").value || "0");
        const unit = document.getElementById("prepUnit").value.trim();
        const shift = document.getElementById("prepShift").value;
        const pic = document.getElementById("prepPic").value.trim();
        const note = document.getElementById("prepNote").value.trim();

        if (!item) {
          alert("Nama item/menu wajib diisi.");
          return;
        }

        state.prep[outletId].push({
          id: "PREP-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
          date,
          item,
          qty: isNaN(qty) ? 0 : qty,
          unit,
          shift,
          pic,
          note,
          verified: false,
          verifiedAt: null,
        });

        saveState();
        prepForm.reset();
        refreshPrepPicOptions();
        renderPrep();
        updateDashboard();
      });

      const cleanForm = document.getElementById("cleanForm");
      const cleanCategorySelect = document.getElementById("cleanCategory");
      const cleanItemsList = document.getElementById("cleanItemsList");

      // Bangun daftar checklist item berdasarkan kategori (menggunakan template yang bisa diatur admin)
      const buildCleanItemsList = () => {
        if (!cleanCategorySelect || !cleanItemsList) return;
        const categoryValue = cleanCategorySelect.value || "";
        const source = state && state.cleanTemplates ? state.cleanTemplates : CLEAN_CATEGORY_ITEMS;
        const items = source[categoryValue] || [];
        cleanItemsList.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "text-slate-500";
          empty.textContent = "Belum ada item untuk kategori ini.";
          cleanItemsList.appendChild(empty);
          return;
        }
        items.forEach((name, index) => {
          const row = document.createElement("div");
          row.className = "flex items-start gap-2 py-1 border-b border-slate-200 last:border-b-0";
          row.innerHTML = `
            <div class="flex-1">
              <div class="font-medium text-[11px]">${name}</div>
              <div class="mt-1 flex items-center gap-3 text-[11px]">
                <label class="inline-flex items-center gap-1">
                  <input type="radio" name="clean-result-${index}" value="OK" class="clean-result-radio" />
                  <span>OK</span>
                </label>
                <label class="inline-flex items-center gap-1">
                  <input type="radio" name="clean-result-${index}" value="Tidak OK" class="clean-result-radio" />
                  <span>Tidak OK</span>
                </label>
              </div>
              <div class="mt-1 hidden" data-fix-wrapper>
                <input type="text" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Perbaikan (jika Tidak OK)" />
              </div>
            </div>
          `;
          // simpan nama item di attribute data
          row.dataset.itemName = name;
          cleanItemsList.appendChild(row);
        });

        // Atur show/hide perbaikan per baris
        cleanItemsList.querySelectorAll(".clean-result-radio").forEach((radio) => {
          radio.addEventListener("change", (ev) => {
            const wrapper = ev.target.closest("div").parentElement.parentElement.querySelector("[data-fix-wrapper]");
            if (!wrapper) return;
            if (ev.target.value === "Tidak OK" && ev.target.checked) {
              wrapper.classList.remove("hidden");
            } else if (ev.target.value === "OK" && ev.target.checked) {
              wrapper.classList.add("hidden");
              const input = wrapper.querySelector("input[type='text']");
              if (input) input.value = "";
            }
          });
        });
      };

      if (cleanCategorySelect && cleanItemsList) {
        cleanCategorySelect.addEventListener("change", () => {
          buildCleanItemsList();
        });
        // Inisialisasi awal
        buildCleanItemsList();
      }

      cleanForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const category = document.getElementById("cleanCategory").value;
        const date = document.getElementById("cleanDate").value || todayStr();

        const rows = Array.from(cleanItemsList.querySelectorAll("[data-item-name]"));
        if (!rows.length) {
          alert("Tidak ada item checklist untuk kategori ini.");
          return;
        }

        // Validasi: pastikan setiap item sudah dipilih OK / Tidak OK
        for (const row of rows) {
          const radios = row.querySelectorAll(".clean-result-radio");
          const hasSelection = Array.from(radios).some((r) => r.checked);
          if (!hasSelection) {
            alert("Masih ada item checklist yang belum dipilih OK / Tidak OK. Silakan pilih hasil untuk semua item sebelum menyimpan.");
            return;
          }
        }

        let addedCount = 0;
        rows.forEach((row) => {
          const area = row.dataset.itemName || "";
          const radios = row.querySelectorAll(".clean-result-radio");
          const selectedRadio = Array.from(radios).find((r) => r.checked);
          const result = selectedRadio ? selectedRadio.value : null;
          const fixWrapper = row.querySelector("[data-fix-wrapper]");
          const noteInput = fixWrapper ? fixWrapper.querySelector("input[type='text']") : null;
          const note = noteInput ? noteInput.value.trim() : "";

          // Simpan semua item, baik OK maupun Tidak OK, supaya ada rekam jejak lengkap
          if (area && result) {
            const initialStatus = result === "OK" ? "Selesai" : "Belum";
            state.cleaning[outletId].push({
              id: "CLN-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
              area,
              category,
              date,
              result,
              status: initialStatus,
              note,
            });
            addedCount++;
          }
        });

        if (!addedCount) {
          alert("Tidak ada item yang berhasil disimpan.");
          return;
        }

        saveState();
        // Jangan reset kategori, hanya rebuild list agar input perbaikan kosong lagi
        buildCleanItemsList();
        renderCleaning();
        updateDashboard();
      });

      const scheduleMonthInput = document.getElementById("scheduleMonth");
      const scheduleDateInput = document.getElementById("scheduleDate");
      const schedulePeriodLabel = document.getElementById("schedulePeriodLabel");

      if (scheduleMonthInput && schedulePeriodLabel) {
        const updateSchedulePeriodLabel = () => {
          const val = scheduleMonthInput.value;
          if (!val) {
            schedulePeriodLabel.textContent = "Periode: -";
            return;
          }
          const range = getSchedulePeriodRange(val);
          if (!range) {
            schedulePeriodLabel.textContent = "Periode: -";
            return;
          }
          const opts = { day: "2-digit", month: "short", year: "numeric" };
          const startLabel = range.start.toLocaleDateString("id-ID", opts);
          const endLabel = range.end.toLocaleDateString("id-ID", opts);
          schedulePeriodLabel.textContent = `Periode: ${startLabel} - ${endLabel}`;
        };

        scheduleMonthInput.addEventListener("change", () => {
          updateSchedulePeriodLabel();
          renderSchedule();
        });

        updateSchedulePeriodLabel();
      }

      const scheduleForm = document.getElementById("scheduleForm");
      scheduleForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const name = document.getElementById("scheduleName").value.trim();
        let date = document.getElementById("scheduleDate").value || todayStr();
        const shift = document.getElementById("scheduleShift").value.trim();
        const role = document.getElementById("scheduleRole").value.trim();

        if (!name) {
          alert("Nama karyawan wajib diisi.");
          return;
        }

        // Peringatan jika tanggal di luar periode 21 - 20 untuk bulan yang dipilih
        if (scheduleMonthInput && scheduleMonthInput.value) {
          const range = getSchedulePeriodRange(scheduleMonthInput.value);
          if (range) {
            const d = new Date(date + "T00:00:00");
            if (!isNaN(d.getTime()) && (d < range.start || d > range.end)) {
              const proceed = confirm("Tanggal yang dipilih di luar periode 21 - 20 untuk bulan yang dipilih. Tetap simpan?");
              if (!proceed) {
                return;
              }
            }
          }
        }

        state.schedules[outletId].push({
          id: "SCH-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
          name,
          date,
          shift,
          role,
        });

        saveState();
        scheduleForm.reset();
        renderSchedule();
        refreshPrepPicOptions();
        refreshTasksNameOptions();
        updateDashboard();
      });

      const tasksForm = document.getElementById("tasksForm");
      tasksForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const date = document.getElementById("tasksDate").value || todayStr();
        const name = document.getElementById("tasksName").value.trim();
        const desc = document.getElementById("tasksDesc").value.trim();

        if (!name || !desc) {
          alert("Nama karyawan dan deskripsi tugas wajib diisi.");
          return;
        }

        state.tasks[outletId].push({
          id: "TSK-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
          date,
          name,
          desc,
          status: "Belum",
        });

        saveState();
        tasksForm.reset();
        renderTasks();
        updateDashboard();
      });

      const fbForm = document.getElementById("fbForm");
      const fbChannelSelect = document.getElementById("fbChannel");
      if (fbChannelSelect) {
        fbChannelSelect.addEventListener("change", () => {
          updateFbRatingOptions();
        });
      }
      const fbRatingSelect = document.getElementById("fbRating");
      if (fbRatingSelect) {
        fbRatingSelect.addEventListener("change", () => {
          updateFbCategoryOptions();
        });
      }
      fbForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const outletId = state.selectedOutletId;
        ensureOutletContainers(outletId);

        const date = document.getElementById("fbDate").value || todayStr();
        const channel = document.getElementById("fbChannel").value;
        const customer = document.getElementById("fbCustomer").value.trim();
        const rating = parseInt(document.getElementById("fbRating").value, 10) || 0;
        const category = document.getElementById("fbCategory").value;
        const comment = document.getElementById("fbComment").value.trim();

        if (!comment) {
          alert("Komentar wajib diisi (boleh singkat).");
          return;
        }
        if (!category) {
          alert("Kategori wajib dipilih.");
          return;
        }

        state.feedback[outletId].push({
          id: "FB-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
          date,
          channel,
          customer,
          rating,
          category,
          comment,
        });

        saveState();
        fbForm.reset();
        updateFbRatingOptions();
        renderFeedback();
        updateDashboard();
      });

      // Pengaturan Checklist (Admin)
      const checklistForm = document.getElementById("checklistForm");
      const checklistFilterCategory = document.getElementById("checklistFilterCategory");
      if (checklistForm) {
        checklistForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (state.role === 'karyawan') {
            alert("Hanya Kepala Cabang dan Admin yang boleh mengubah template checklist.");
            return;
          }
          const category = document.getElementById("checklistCategory").value || "Cleaning";
          const name = document.getElementById("checklistName").value.trim();
          if (!name) {
            alert("Nama item checklist wajib diisi.");
            return;
          }
          if (!state.cleanTemplates) {
            try {
              state.cleanTemplates = JSON.parse(JSON.stringify(CLEAN_CATEGORY_ITEMS));
            } catch (e) {
              state.cleanTemplates = CLEAN_CATEGORY_ITEMS;
            }
          }
          if (!state.cleanTemplates[category]) state.cleanTemplates[category] = [];
          state.cleanTemplates[category].push(name);
          saveState();
          checklistForm.reset();
          renderChecklistTemplates();
        });
      }
      if (checklistFilterCategory) {
        checklistFilterCategory.addEventListener("change", () => {
          renderChecklistTemplates();
        });
      }

      // Log Book
      const logForm = document.getElementById("logForm");
      if (logForm) {
        logForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const outletId = state.selectedOutletId;
          ensureOutletContainers(outletId);

          const date = document.getElementById("logDate").value || todayStr();
          const shift = document.getElementById("logShift").value;
          const author = document.getElementById("logAuthor").value.trim();
          const title = document.getElementById("logTitle").value.trim();
          const content = document.getElementById("logContent").value.trim();
          const forNextShift = document.getElementById("logForNextShift").checked;

          if (!content) {
            alert("Isi catatan wajib diisi.");
            return;
          }

          state.logbook[outletId].push({
            id: "LOG-" + Date.now() + "-" + Math.random().toString(36).slice(2, 6),
            date,
            shift,
            author,
            title,
            content,
            forNextShift,
          });

          saveState();
          logForm.reset();
          const logDateInput = document.getElementById("logDate");
          if (logDateInput) logDateInput.value = date;
          renderLogbook();
        });
      }

      const outletForm = document.getElementById("outletForm");
      outletForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (state.role !== 'admin') {
          alert("Hanya Admin yang boleh mengubah data outlet.");
          return;
        }

        if (state.outlets.length >= 100) {
          alert("Batas maksimal 100 outlet sudah tercapai.");
          return;
        }

        const name = document.getElementById("outletName").value.trim();
        const location = document.getElementById("outletLocation").value.trim();

        if (!name) {
          alert("Nama outlet wajib diisi.");
          return;
        }

        let nextNum = 1;
        while (true) {
          const id = "OUT-" + nextNum;
          if (!state.outlets.some((o) => o.id === id)) {
            state.outlets.push({ id, name, location });
            ensureOutletContainers(id);
            break;
          }
          nextNum++;
          if (nextNum > 200) break;
        }

        saveState();
        outletForm.reset();
        renderOutlets();
        renderOutletDropdown();
        refreshOutletLabels();
        updateDashboard();
      });

      // Reset / bersihkan data stok keluar berdasarkan rentang hari
      const invCleanupForm = document.getElementById("invCleanupForm");
      if (invCleanupForm) {
        invCleanupForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const rangeSelect = document.getElementById("invCleanupRange");
          const daysStr = rangeSelect ? rangeSelect.value : "";
          const days = parseInt(daysStr, 10);
          if (!days || days <= 0) {
            alert("Pilih rentang hari terlebih dahulu.");
            return;
          }

          const outletId = state.selectedOutletId;
          ensureOutletContainers(outletId);

          const today = new Date(todayStr() + "T00:00:00");
          const cutoff = new Date(today.getTime() - days * 24 * 60 * 60 * 1000);

          const beforeCount = state.stockOut[outletId].length;
          state.stockOut[outletId] = state.stockOut[outletId].filter((rec) => {
            if (!rec.date) return true;
            const d = new Date(rec.date + "T00:00:00");
            if (isNaN(d.getTime())) return true;
            // Simpan hanya yang tanggalnya >= cutoff (lebih baru atau sama dengan batas)
            return d >= cutoff;
          });
          const afterCount = state.stockOut[outletId].length;
          const removed = beforeCount - afterCount;

          saveState();
          renderStockOut();

          if (removed > 0) {
            alert(`${removed} transaksi stok keluar lama dibersihkan. Stok inventori saat ini tidak diubah.`);
          } else {
            alert("Tidak ada transaksi stok keluar yang lebih lama dari rentang tersebut.");
          }
        });
      }

      const cleanFilterDateInput = document.getElementById("cleanFilterDate");
      if (cleanFilterDateInput) {
        cleanFilterDateInput.addEventListener("change", () => {
          renderCleaning();
        });
      }
      const cleanFilterCategorySelect = document.getElementById("cleanFilterCategory");
      if (cleanFilterCategorySelect) {
        cleanFilterCategorySelect.addEventListener("change", () => {
          renderCleaning();
        });
      }

      const stockOutFilterDateInput = document.getElementById("stockOutFilterDate");
      if (stockOutFilterDateInput) {
        stockOutFilterDateInput.addEventListener("change", () => {
          renderStockOut();
        });
      }

      const prepFilterDateInput = document.getElementById("prepFilterDate");
      if (prepFilterDateInput) {
        prepFilterDateInput.addEventListener("change", () => {
          renderPrep();
        });
      }

      const tasksFilterDateInput = document.getElementById("tasksFilterDate");
      if (tasksFilterDateInput) {
        tasksFilterDateInput.addEventListener("change", () => {
          renderTasks();
        });
      }

      const fbFilterDateInput = document.getElementById("fbFilterDate");
      if (fbFilterDateInput) {
        fbFilterDateInput.addEventListener("change", () => {
          renderFeedback();
        });
      }
      const fbFilterChannelSelect = document.getElementById("fbFilterChannel");
      if (fbFilterChannelSelect) {
        fbFilterChannelSelect.addEventListener("change", () => {
          renderFeedback();
        });
      }

      const rejectFilterDateInput = document.getElementById("rejectFilterDate");
      if (rejectFilterDateInput) {
        rejectFilterDateInput.addEventListener("change", () => {
          renderRejects();
        });
      }

      const logFilterDateInput = document.getElementById("logFilterDate");
      if (logFilterDateInput) {
        logFilterDateInput.addEventListener("change", () => {
          renderLogbook();
        });
      }

      // Backup & Restore Data (Admin)
      const backupDownloadBtn = document.getElementById("backupDownloadBtn");
      const backupUploadInput = document.getElementById("backupUploadInput");
      const backupToSheetsBtn = document.getElementById("backupToSheetsBtn");

      if (backupDownloadBtn) {
        backupDownloadBtn.addEventListener("click", () => {
          if (!state.isAdmin) {
            alert("Hanya admin yang boleh melakukan backup data.");
            return;
          }
          try {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const ts = new Date().toISOString().replace(/[:.]/g, "-");
            a.href = url;
            a.download = `resto-ops-hub-backup-${ts}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (e) {
            console.error("Gagal membuat backup", e);
            alert("Gagal membuat backup. Silakan coba lagi.");
          }
        });
      }

      if (backupUploadInput) {
        backupUploadInput.addEventListener("change", (e) => {
          if (!state.isAdmin) {
            alert("Hanya admin yang boleh melakukan restore data.");
            backupUploadInput.value = "";
            return;
          }
          const file = e.target.files && e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const imported = JSON.parse(ev.target.result);
              if (!imported || typeof imported !== "object") {
                throw new Error("Format file tidak valid");
              }
              const confirmRestore = confirm(
                "Import backup akan mengganti seluruh data di perangkat ini (semua outlet, inventori, jadwal, tugas, dll.). Lanjutkan?"
              );
              if (!confirmRestore) return;

              state = imported;
              saveState();
              renderOutletDropdown();
              updateAdminUI();
              renderOutlets();
              renderAllForCurrentOutlet();
              refreshPrepPicOptions();
              refreshTasksNameOptions();
              updateFbRatingOptions();
              alert("Import backup berhasil. Data telah diperbarui.");
            } catch (err) {
              console.error("Gagal import backup", err);
              alert("File backup tidak valid atau rusak.");
            } finally {
              backupUploadInput.value = "";
            }
          };
          reader.readAsText(file);
        });
      }

      if (backupToSheetsBtn) {
        backupToSheetsBtn.addEventListener("click", async () => {
          if (!state.isAdmin) {
            alert("Hanya admin yang boleh mengirim backup ke Google Sheets.");
            return;
          }
          if (!GOOGLE_SHEETS_WEBAPP_URL) {
            alert("URL Web App Google Sheets belum dikonfigurasi di kode (konstanta GOOGLE_SHEETS_WEBAPP_URL).");
            return;
          }
          const confirmSend = confirm(
            "Kirim salinan penuh semua data (semua outlet, inventori, jadwal, tugas, feedback, log book, dll.) ke Google Sheets sekarang?"
          );
          if (!confirmSend) return;

          try {
            const payload = {
              action: "backupFullState",
              state,
              device: navigator.userAgent || "browser-unknown",
              outletId: state.selectedOutletId || "all",
            };

            // Gunakan mode "no-cors" dan tanpa header custom untuk menghindari blokir CORS dari browser.
            // Kita tidak membaca respons kembali; backup bersifat fire-and-forget.
            await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
              method: "POST",
              mode: "no-cors",
              body: JSON.stringify(payload),
            });

            alert(
              "Permintaan backup telah dikirim ke Google Sheets. Silakan cek sheet 'backup_json' di spreadsheet Apps Script Anda untuk memastikan baris backup baru sudah masuk."
            );
          } catch (err) {
            console.error("Gagal mengirim ke Google Sheets", err);
            alert("Gagal mengirim backup ke Google Sheets. Periksa koneksi internet dan URL Web App.");
          }
        });
      }

    }

    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      renderOutletDropdown();
      updateAdminUI();

      // Isi opsi contoh Nama Item untuk inventori (datalist)
      const invNameDatalist = document.getElementById("invNameList");
      if (invNameDatalist && Array.isArray(INVENTORY_ITEM_TEMPLATES)) {
        invNameDatalist.innerHTML = "";
        INVENTORY_ITEM_TEMPLATES.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          invNameDatalist.appendChild(opt);
        });
      }

      const prepDate = document.getElementById("prepDate");
      const cleanDate = document.getElementById("cleanDate");
      const tasksDate = document.getElementById("tasksDate");
      const fbDate = document.getElementById("fbDate");
      const scheduleDate = document.getElementById("scheduleDate");
      const scheduleMonth = document.getElementById("scheduleMonth");
      const stockOutDate = document.getElementById("stockOutDate");
      const logDate = document.getElementById("logDate");
      const cleanFilterDate = document.getElementById("cleanFilterDate");
      const stockOutFilterDate = document.getElementById("stockOutFilterDate");
      const prepFilterDate = document.getElementById("prepFilterDate");
      const tasksFilterDate = document.getElementById("tasksFilterDate");
      const fbFilterDate = document.getElementById("fbFilterDate");
      const logFilterDate = document.getElementById("logFilterDate");
      const today = todayStr();

      if (prepDate) prepDate.value = today;
      if (cleanDate) cleanDate.value = today;
      if (tasksDate) tasksDate.value = today;
      if (fbDate) fbDate.value = today;
      if (scheduleDate) scheduleDate.value = today;
      if (scheduleMonth) scheduleMonth.value = today.slice(0, 7);
      if (stockOutDate) stockOutDate.value = today;
      if (logDate) logDate.value = today;
      if (cleanFilterDate) cleanFilterDate.value = today;
      if (stockOutFilterDate) stockOutFilterDate.value = today;
      if (prepFilterDate) prepFilterDate.value = today;
      if (tasksFilterDate) tasksFilterDate.value = today;
      if (fbFilterDate) fbFilterDate.value = today;
      if (logFilterDate) logFilterDate.value = today;

      renderOutlets();
      renderAllForCurrentOutlet();
      setupEventListeners();
      refreshPrepPicOptions();
      updateFbRatingOptions();
      switchSection("dashboard");
    });
  </script>
</body>
</html>
